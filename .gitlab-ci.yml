stages:
  - build
  - test
  - deploy

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONUNBUFFERED: "1"

# Stage 1 — Build environment
build_app:
  stage: build
  tags:
    - utility-runner
  image: python:3.12-slim
  script:
    - echo "🏗️ Building RetroIPTVGuide environment..."
    - python3 --version
    - pip install --upgrade pip
    - if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    - python -m py_compile $(find . -name "*.py" || echo "No Python files to compile")
    - echo "✅ Build complete."
  artifacts:
    paths:
      - ./
    expire_in: 1h

# Stage 2 — Simple syntax/runtime test
test_app:
  stage: test
  tags:
    - utility-runner
  image: python:3.12-slim
  script:
    - echo "🧪 Running basic unit tests..."
    - if [ -d tests ]; then python -m unittest discover -s tests; else echo "No tests found, skipping."; fi
    - echo "✅ Tests passed."

# Stage 3 — Local deployment simulation
deploy_app:
  stage: deploy
  tags:
    - utility-runner
  image: alpine:latest
  script:
    - echo "🚀 Deploying RetroIPTVGuide to /opt/retroiptvguide..."
    - mkdir -p /opt/retroiptvguide
    - cp -r . /opt/retroiptvguide/
    - echo "✅ Deployed to /opt/retroiptvguide"
  when: manual
