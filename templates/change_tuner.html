<!doctype html>
<html>
<head>
    <title>Change Tuner</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
</head>
<body>
<div class="header">
    <div class="links">
        <span style="margin-right:20px; font-weight:bold;">Active Tuner: {{ current_tuner }}</span>
        <a href="{{ url_for('guide') }}">HOME</a>
        {% if current_user is defined and current_user.username == 'admin' %}
        <!-- ✅ Added next to USER ADMIN -->
		<a href="{{ url_for('manage_users') }}" id="manageUsersMenu">MANAGE USERS</a>
        {% endif %}

        <div class="dropdown" id="settingsMenu">
            <button class="dropbtn">SETTINGS ▾</button>
            <div class="dropdown-content">
                {% if current_user is defined and current_user.username == 'admin' %}
                <a href="{{ url_for('change_tuner') }}">Change Tuner</a>
                <a href="{{ url_for('view_logs') }}">Logs</a>
                <li><a href="{{ url_for('about') }}">About</a></li>
                {% endif %}
                <a href="{{ url_for('change_password') }}">Change Password</a>
				<li class="submenu">
				  <a href="#">Themes</a>
				  <ul class="submenu-content">
				    <li><a href="#" onclick="setTheme('light'); return false;">Light</a></li>
				    <li><a href="#" onclick="setTheme('dark'); return false;">Dark</a></li>
					<li><a href="#" onclick="setTheme('retro-aol'); return false;">AOL / CompuServe</a></li>
					<li><a href="#" onclick="setTheme('retro-magazine'); return false;">TV Guide Magazine</a></li>
					<li><a href="#" onclick="setTheme('directv'); return false;">DirecTV</a></li>
					<li><a href="#" onclick="setTheme('comcast'); return false;">Comcast</a></li>
				  </ul>
				</li>
            </div>
        </div>

        <a href="{{ url_for('logout') }}">LOGOUT</a>
    </div>
    <div id="clock" class="clock">--:-- --</div>
</div>

<div class="box">
    <h2>Change Active Tuner</h2>
    <form method="POST">
        <input type="hidden" name="action" value="switch_tuner">
        <label for="tuner">Select Tuner:</label>
        <select name="tuner" id="tuner" required>
            {% for tuner in tuners %}
            <option value="{{ tuner }}" {% if tuner == current_tuner %}selected{% endif %}>{{ tuner }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="primary">Set Active Tuner</button>
    </form>
</div>

<div class="box">
    <h2>Update Tuner URLs</h2>
    <form method="POST">
        <input type="hidden" name="action" value="update_urls">
        <label for="tuner_update">Select Tuner:</label>
        <select name="tuner" id="tuner_update" required onchange="populateUrls(this.value)">
            {% for tuner in tuners %}
            <option value="{{ tuner }}">{{ tuner }}</option>
            {% endfor %}
        </select>
        <input type="text" name="xml_url" id="xml_url" placeholder="XML URL (.xml)" required>
        <input type="text" name="m3u_url" id="m3u_url" placeholder="M3U URL (.m3u)" required>
        <button type="submit" class="primary">Update URLs</button>
    </form>
</div>


<div class="box">
    <h2>Manage Tuners</h2>

    <!-- Add new tuner -->
    <form method="POST" style="margin-bottom:20px;">
        <input type="hidden" name="action" value="add_tuner">
        <input type="text" name="tuner_name" placeholder="New Tuner Name" required>
        <input type="text" name="xml_url" placeholder="XML URL (.xml)" required>
        <input type="text" name="m3u_url" placeholder="M3U URL (.m3u)" required>
        <button type="submit" class="primary">Add Tuner</button>
    </form>

    <!-- Remove existing tuner -->
    <form method="POST">
        <input type="hidden" name="action" value="delete_tuner">   <!-- FIXED -->
        <label for="tuner_remove">Delete Tuner:</label>
        <select name="tuner" id="tuner_remove" required>
            {% for tuner in tuners %}
            {% if tuner != current_tuner %}
            <option value="{{ tuner }}">{{ tuner }}</option>
            {% endif %}
            {% endfor %}
        </select>
        <button type="submit" class="primary">Delete Tuner</button>
    </form>

</div>

<div class="box">
    <h2>Rename Tuner</h2>
    <form method="POST">
        <input type="hidden" name="action" value="rename_tuner">
        <label for="tuner_rename">Select Tuner:</label>
        <select name="tuner" id="tuner_rename" required>
            {% for tuner in tuners %}
            <option value="{{ tuner }}">{{ tuner }}</option>
            {% endfor %}
        </select>
        <input type="text" name="new_name" placeholder="New Tuner Name" required>
        <button type="submit" class="primary">Rename</button>
    </form>
</div>

<script>
const tunerData = {{ TUNERS|tojson }};

function populateUrls(tuner) {
    if (tunerData[tuner]) {
        document.getElementById('xml_url').value = tunerData[tuner].xml || "";
        document.getElementById('m3u_url').value = tunerData[tuner].m3u || "";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const saved = localStorage.getItem("theme") || "dark";
    setTheme(saved);
    updateClock();
    setInterval(updateClock, 1000);
    // Initialize update form with first tuner’s URLs
    const firstTuner = document.getElementById('tuner_update').value;
    populateUrls(firstTuner);
});

function setTheme(theme) {
    const body = document.body;
    body.classList.remove("light", "dark", "retro-tvguide", "retro-aol", "retro-webtv", "retro-tvguide2000", "retro-magazine", "directv", "comcast");
    body.classList.add(theme);
    localStorage.setItem("theme", theme);
}
function updateClock() {
    const now = new Date();
    const el = document.getElementById('clock');
    if (el) {
        el.textContent = now.toLocaleString([], {
            weekday:'short', month:'short', day:'numeric',
            hour:'2-digit', minute:'2-digit', second:'2-digit'
        });
    }
}
</script>
</body>
</html>

