{% extends "base.html" %}
{% block title %}Change Tuner â€” IPTV Guide{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/change_tuner.css') }}">
{% endblock %}

{% block content %}
<div class="container-change-tuner">
  <header class="page-header">
    <h1>Tuners</h1>
    <p class="lead">Switch the active tuner, edit tuner sources, and manage tuners. Dangerous actions are separated below to avoid accidental deletion.</p>
  </header>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages-container">
        {% for category, message in messages %}
          <div class="flash-message flash-{{ category if category else 'default' }}">
            <span class="flash-content">{{ message }}</span>
            <button class="flash-close" aria-label="Close message">&times;</button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <main class="card-grid">
    <!-- Active tuner + Auto-refresh combined -->
    <section class="card card-primary" aria-labelledby="lbl-active-tuner">
      <div class="card-head">
        <h2 id="lbl-active-tuner">Active Tuner & Auto-refresh</h2>
      </div>
      <div class="card-body">
        <form method="POST" class="compact-form" id="form-switch">
          <input type="hidden" name="action" value="switch_tuner">
          <label for="tuner">Select Active Tuner</label>
          <select name="tuner" id="tuner" required>
            {% for tuner in tuners %}
            <option value="{{ tuner }}" {% if tuner == current_tuner %}selected{% endif %}>{{ tuner }}</option>
            {% endfor %}
          </select>

          <div class="form-row form-row-inline">
            <button type="submit" class="primary">Set Active Tuner</button>
            <button type="button" class="secondary" id="btn-run-now" title="Run refresh now">Run Now</button>
          </div>
        </form>

        <hr class="divider" aria-hidden="true">

        <!-- Auto-refresh settings inline with active tuner -->
        <form method="POST" class="compact-form" id="form-autorefresh">
          <input type="hidden" name="action" value="update_auto_refresh">
          <div class="row-inline">
            <div class="col">
              <label for="auto_refresh_enabled">Auto-refresh</label>
              <select id="auto_refresh_enabled" name="auto_refresh_enabled" class="form-control">
                <option value="0" {% if _ar_enabled in ['0','False','false'] %}selected{% endif %}>Off</option>
                <option value="1" {% if _ar_enabled in ['1','True','true'] %}selected{% endif %}>On</option>
              </select>
            </div>
            <div class="col">
              <label for="auto_refresh_interval">Interval (hours)</label>
              <select id="auto_refresh_interval" name="auto_refresh_interval_hours" class="form-control">
                <option value="" {% if not _ar_interval %}selected{% endif %}>Select interval</option>
                <option value="2" {% if _ar_interval|string == '2' %}selected{% endif %}>Every 2 hours</option>
                <option value="4" {% if _ar_interval|string == '4' %}selected{% endif %}>Every 4 hours</option>
                <option value="6" {% if _ar_interval|string == '6' %}selected{% endif %}>Every 6 hours</option>
                <option value="12" {% if _ar_interval|string == '12' %}selected{% endif %}>Every 12 hours</option>
                <option value="24" {% if _ar_interval|string == '24' %}selected{% endif %}>Every 24 hours</option>
              </select>
            </div>
          </div>

          <div class="form-row form-row-inline" style="margin-top:10px;">
            <button type="submit" class="primary">Save Auto-refresh</button>
            <button type="button" class="btn-link" id="btn-view-last">View Last Run</button>
          </div>

          <div class="muted small" id="auto-refresh-meta" style="margin-top:10px;">
            {% if last_auto_refresh is defined and last_auto_refresh %}
              {% set parts = last_auto_refresh.split('|') %}
              <strong>Last:</strong> {{ parts[1] if parts|length > 1 else last_auto_refresh }}
              {% if parts[0] %}
              &nbsp;â€¢&nbsp;<em>{{ parts[0] }}</em>
              {% endif %}
            {% else %}
              No automatic refresh recorded yet.
            {% endif %}
          </div>
        </form>
      </div>
    </section>

    <!-- Edit / Add Tuners: Update URLs, Add, Rename grouped (delete separated) -->
    <section class="card" aria-labelledby="lbl-edit-tuners">
      <div class="card-head">
        <h2 id="lbl-edit-tuners">Edit / Add Tuners</h2>
      </div>
      <div class="card-body">
        <div class="subgrid">
          <!-- Update selected tuner URLs -->
          <div>
            <form method="POST" class="compact-form" id="form-update-urls">
              <input type="hidden" name="action" value="update_urls">
              <label for="tuner_update">Select Tuner</label>
              <select name="tuner" id="tuner_update" required onchange="populateUrls(this.value)">
                {% for tuner in tuners %}
                {% if TUNERS[tuner].tuner_type != 'combined' %}
                <option value="{{ tuner }}">{{ tuner }}</option>
                {% endif %}
                {% endfor %}
              </select>

              <label for="xml_url">XML URL (.xml)</label>
              <input type="text" name="xml_url" id="xml_url" placeholder="XML URL (.xml)" required>

              <label for="m3u_url">M3U URL (.m3u)</label>
              <input type="text" name="m3u_url" id="m3u_url" placeholder="M3U URL (.m3u)" required>

              <div class="form-row form-row-inline">
                <button type="submit" class="primary">Update URLs</button>
                <button type="button" class="btn-link" id="btn-validate" title="Check reachability">Validate</button>
              </div>
            </form>
          </div>

          <!-- Add new tuner & Rename -->
          <div>
            <form method="POST" class="compact-form" id="form-add-tuner">
              <input type="hidden" name="action" value="add_tuner">
              <label for="tuner_name">Add new tuner</label>
              <input type="text" id="tuner_name" name="tuner_name" placeholder="New Tuner Name" required>

              <!-- Mode selection -->
              <div class="mode-selection" style="margin-top: 12px;">
                <label style="display: block; margin-bottom: 8px;">Tuner Mode</label>
                <div style="display: flex; gap: 16px; flex-wrap: wrap;">
                  <label for="tuner_mode_standard" style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
                    <input type="radio" id="tuner_mode_standard" name="tuner_mode" value="standard" checked>
                    Standard Playlist Mode
                  </label>
                  <label for="tuner_mode_single_stream" style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
                    <input type="radio" id="tuner_mode_single_stream" name="tuner_mode" value="single_stream">
                    Single Stream Mode
                  </label>
                  <label for="tuner_mode_combined" style="display: flex; align-items: center; gap: 6px; font-weight: normal;">
                    <input type="radio" id="tuner_mode_combined" name="tuner_mode" value="combined">
                    Combined Tuner
                  </label>
                </div>
                <p class="muted small" style="margin: 6px 0 0 0;">Standard mode requires both XML and M3U playlist URLs. Single stream mode is for a direct M3U8 stream URL. Combined mode merges channels and guide data from multiple existing tuners.</p>
              </div>

              <!-- Standard mode fields -->
              <div id="standard-fields">
                <label for="xml_new">XML URL</label>
                <input type="text" id="xml_new" name="xml_url" placeholder="http://.../guide.xml">

                <label for="m3u_new">M3U URL</label>
                <input type="text" id="m3u_new" name="m3u_url" placeholder="http://.../playlist.m3u">
              </div>

              <!-- Single stream mode fields -->
              <div id="stream-fields" style="display: none;">
                <label for="m3u8_stream">M3U8 Stream URL</label>
                <input type="text" id="m3u8_stream" name="m3u8_stream_url" placeholder="http://.../stream.m3u8">
                <p class="muted small" style="margin: 6px 0 0 0;">Direct link to a single M3U8 stream. Channel name will be auto-generated from the tuner name.</p>
              </div>

              <!-- Combined mode fields -->
              <div id="combined-fields" style="display: none;">
                <label for="source_tuners">Source Tuners (hold Ctrl/Cmd to select multiple)</label>
                <select id="source_tuners" name="source_tuners" multiple size="4" style="min-height: 80px;">
                  {% for tuner in tuners %}
                  <option value="{{ tuner }}">{{ tuner }}</option>
                  {% endfor %}
                </select>
                <p class="muted small" style="margin: 6px 0 0 0;">Select two or more tuners to combine. Their channels and guide data will be merged into a single tuner.</p>
              </div>

              <button type="submit" class="primary">Add Tuner</button>
            </form>

            <hr class="divider" aria-hidden="true">

            <form method="POST" class="compact-form" id="form-rename">
              <input type="hidden" name="action" value="rename_tuner">
              <label for="tuner_rename">Rename tuner</label>
              <select name="tuner" id="tuner_rename" required>
                {% for tuner in tuners %}
                <option value="{{ tuner }}">{{ tuner }}</option>
                {% endfor %}
              </select>
              <input type="text" name="new_name" placeholder="New Tuner Name" required>
              <button type="submit" class="primary">Rename</button>
            </form>
          </div>
        </div>
      </div>
    </section>

    <!-- Virtual Channels: admin control for built-in virtual channels -->
    <section class="card" aria-labelledby="lbl-virtual-channels">
      <div class="card-head">
        <h2 id="lbl-virtual-channels">Virtual Channels</h2>
      </div>
      <div class="card-body">
        <p class="muted small" style="margin-top:0; margin-bottom:12px;">Enable or disable the built-in virtual channels that appear in the guide. Use <strong>âš™ Overlay</strong> to customize each channel's overlay colors and test banner.</p>
        <!-- form element is empty here so prefs sub-forms can live outside it.
             Checkboxes and the Save button reference it via form="form-virtual-channels". -->
        <form method="POST" id="form-virtual-channels">
          <input type="hidden" name="action" value="update_virtual_channels">
        </form>
        <div class="vc-channel-list">
          {% for ch in VIRTUAL_CHANNELS %}
          {% set ch_app = channel_appearances.get(ch.tvg_id, {'text_color': '', 'bg_color': '', 'test_text': ''}) %}
          <div class="vc-channel-item">
            <label class="vc-toggle-label">
              <input type="checkbox"
                     form="form-virtual-channels"
                     name="vc_{{ ch.tvg_id }}"
                     value="1"
                     {% if vc_settings.get(ch.tvg_id, true) %}checked{% endif %}>
              <span class="vc-toggle-name">
                {% if ch.logo %}
                <img src="{{ ch.logo }}" alt="" class="vc-logo">
                {% endif %}
                {{ ch.name }}
              </span>
              <span class="muted small vc-type">{{ ch.overlay_type }}</span>
            </label>
            <button type="button" class="secondary small vc-prefs-btn"
                    aria-expanded="false"
                    aria-controls="vc-prefs-{{ loop.index }}"
                    data-panel="vc-prefs-{{ loop.index }}">âš™ Overlay</button>
          </div>
          <div class="vc-prefs-panel" id="vc-prefs-{{ loop.index }}" hidden>
            <form method="POST" class="compact-form vc-prefs-form">
              <input type="hidden" name="action" value="update_channel_overlay_appearance">
              <input type="hidden" name="tvg_id" value="{{ ch.tvg_id }}">
              <div class="vc-prefs-fields">
                {% if ch.tvg_id != 'virtual.weather' %}
                <div class="vc-prefs-field">
                  <label>Text Color</label>
                  <div class="form-row form-row-inline" style="gap:6px; align-items:center;">
                    <input type="color" name="ch_text_color"
                           value="{{ ch_app.text_color or '#ffffff' }}">
                    <button type="button" class="secondary small vc-prefs-reset" data-default="#ffffff">Reset</button>
                  </div>
                </div>
                <div class="vc-prefs-field">
                  <label>Background Color</label>
                  <div class="form-row form-row-inline" style="gap:6px; align-items:center;">
                    <input type="color" name="ch_bg_color"
                           value="{{ ch_app.bg_color or '#000000' }}">
                    <button type="button" class="secondary small vc-prefs-reset" data-default="#000000">Reset</button>
                  </div>
                </div>
                {% endif %}
                {% if ch.tvg_id == 'virtual.news' %}
                <div class="vc-prefs-field vc-prefs-field-wide">
                  <label>News Feed URL (RSS/Atom)</label>
                  <input type="url" name="ch_news_rss_url"
                         value="{{ news_feed_url }}"
                         placeholder="https://feeds.example.com/rss.xml"
                         maxlength="500">
                </div>
                {% endif %}
                {% if ch.tvg_id == 'virtual.weather' %}
                <div class="vc-prefs-field vc-prefs-field-wide">
                  <label>US Zip Code Lookup</label>
                  <div class="form-row form-row-inline" style="gap:6px; align-items:center;">
                    <input type="text" id="vc-zip-input" placeholder="e.g. 33101" maxlength="5"
                           inputmode="numeric" pattern="\d{5}" autocomplete="postal-code"
                           style="max-width:120px;">
                    <button type="button" id="vc-zip-lookup-btn" class="secondary small">Look Up</button>
                    <span id="vc-zip-status" class="zip-status" aria-live="polite"></span>
                  </div>
                </div>
                <div class="vc-prefs-field vc-prefs-field-wide">
                  <label>Location Name</label>
                  <input type="text" id="vc-weather-location" name="ch_weather_location"
                         value="{{ weather_config.location_name }}"
                         placeholder="e.g. Miami, FL"
                         maxlength="120">
                </div>
                <div class="vc-prefs-field">
                  <label>Latitude</label>
                  <input type="text" id="vc-weather-lat" name="ch_weather_lat"
                         value="{{ weather_config.lat }}"
                         placeholder="e.g. 25.77"
                         maxlength="20"
                         inputmode="decimal">
                </div>
                <div class="vc-prefs-field">
                  <label>Longitude</label>
                  <input type="text" id="vc-weather-lon" name="ch_weather_lon"
                         value="{{ weather_config.lon }}"
                         placeholder="e.g. -80.19"
                         maxlength="20"
                         inputmode="decimal">
                </div>
                <div class="vc-prefs-field">
                  <label>Units</label>
                  <select name="ch_weather_units">
                    <option value="F" {% if weather_config.units != 'C' %}selected{% endif %}>Â°F â€” Fahrenheit</option>
                    <option value="C" {% if weather_config.units == 'C' %}selected{% endif %}>Â°C â€” Celsius</option>
                  </select>
                </div>
                <div class="vc-prefs-field vc-prefs-field-wide" style="margin-top:4px;">
                  <a href="/weather" target="_blank" class="btn-link small">ðŸŒ¤ Preview Weather Page â†—</a>
                  <span class="muted small" style="margin-left:8px;">Opens in a new tab â€” save settings first.</span>
                </div>
                {% endif %}
              </div>
              <div class="form-row form-row-inline" style="margin-top:10px;">
                <button type="submit" class="primary small">Save</button>
              </div>
            </form>
          </div>
          {% endfor %}
        </div>
        <div class="form-row form-row-inline" style="margin-top:14px;">
          <button type="submit" form="form-virtual-channels" class="primary">Save Channel List</button>
        </div>
      </div>
    </section>

    <!-- Danger Zone: Delete tuner separated to avoid mistakes -->
    <section class="card card-danger" aria-labelledby="lbl-danger-zone">
      <div class="card-head">
        <h2 id="lbl-danger-zone">Danger Zone â€” Delete Tuner</h2>
      </div>
      <div class="card-body">
        <form method="POST" class="compact-form" id="form-delete">
          <input type="hidden" name="action" value="delete_tuner">
          <label for="tuner_remove">Delete tuner (cannot undo)</label>
          <select name="tuner" id="tuner_remove" required>
            {% for tuner in tuners %}
            {% if tuner != current_tuner %}
            <option value="{{ tuner }}">{{ tuner }}</option>
            {% endif %}
            {% endfor %}
          </select>

          <label for="confirm_delete" class="confirm-label">Type the tuner name to confirm</label>
          <input type="text" id="confirm_delete" placeholder="Type tuner name exactly to enable Delete">

          <div class="form-row form-row-inline" style="margin-top:10px;">
            <button type="submit" class="danger" id="btn-delete" disabled>Delete Tuner</button>
            <div class="muted small" style="margin-left:8px;">This action cannot be undone.</div>
          </div>
        </form>
      </div>
    </section>
  </main>
</div>
{% endblock %}

{% block autoscroll_script %}{% endblock %}

{% block scripts_extra %}
<script>
const tunerData = {{ TUNERS|tojson }};

function populateUrls(tuner) {
    if (tunerData && tunerData[tuner]) {
        document.getElementById('xml_url').value = tunerData[tuner].xml || "";
        document.getElementById('m3u_url').value = tunerData[tuner].m3u || "";
    } else {
        document.getElementById('xml_url').value = "";
        document.getElementById('m3u_url').value = "";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    try { if (typeof setTheme === 'function') setTheme(localStorage.getItem('theme') || 'dark'); } catch(e){}

    var sel = document.getElementById('tuner_update');
    if (sel) populateUrls(sel.value);

    // Flash message auto-dismiss and manual close
    try {
      const flashMessages = document.querySelectorAll('.flash-message');
      if (flashMessages.length > 0) {
        // Add close button handlers
        flashMessages.forEach(msg => {
          const closeBtn = msg.querySelector('.flash-close');
          if (closeBtn) {
            closeBtn.addEventListener('click', () => {
              msg.classList.add('fade-out');
              setTimeout(() => msg.remove(), 500);
            });
          }
        });

        // Auto-dismiss after 8 seconds
        setTimeout(() => {
          flashMessages.forEach(msg => {
            if (msg.parentNode) { // Check if still in DOM
              msg.classList.add('fade-out');
              setTimeout(() => {
                if (msg.parentNode) msg.remove();
              }, 500);
            }
          });
        }, 8000);
      }
    } catch (e) {
      // Flash messages will remain visible if auto-dismiss fails
      console.error('Flash message initialization failed:', e);
    }

    // Run Now (uses existing endpoint)
    const runNow = document.getElementById('btn-run-now');
    if (runNow) {
      runNow.addEventListener('click', () => {
        fetch('/api/auto_refresh/trigger', { method: 'POST', credentials: 'same-origin' })
          .then(r => r.json().catch(()=>({ok:false})))
          .then(j => {
            if (j && j.ok) {
              alert('Refresh started');
            } else {
              alert('Refresh request sent (if you have permission).');
            }
          }).catch(()=>alert('Refresh request failed.'));
      });
    }

    // Validate URLs using HEAD
    const validateBtn = document.getElementById('btn-validate');
    if (validateBtn) {
      validateBtn.addEventListener('click', () => {
        const xml = document.getElementById('xml_url').value;
        const m3u = document.getElementById('m3u_url').value;
        const checks = [];
        if (m3u) checks.push(fetch(m3u, { method: 'HEAD' }).then(r => r.ok).catch(()=>false));
        if (xml) checks.push(fetch(xml, { method: 'HEAD' }).then(r => r.ok).catch(()=>false));
        Promise.all(checks).then(results => {
          const ok = results.length > 0 && results.every(Boolean);
          alert(ok ? 'All URLs reachable (HEAD).' : 'One or more URLs not reachable.');
        });
      });
    }

    // Delete confirmation: enable delete button only when typed name matches selected tuner
    const deleteSelect = document.getElementById('tuner_remove');
    const confirmInput = document.getElementById('confirm_delete');
    const deleteBtn = document.getElementById('btn-delete');

    function updateDeleteState() {
      const selected = deleteSelect && deleteSelect.value ? deleteSelect.value.trim() : '';
      const typed = confirmInput && confirmInput.value ? confirmInput.value.trim() : '';
      if (selected && typed && selected === typed) {
        deleteBtn.disabled = false;
      } else {
        deleteBtn.disabled = true;
      }
    }

    if (deleteSelect && confirmInput) {
      deleteSelect.addEventListener('change', () => {
        confirmInput.value = '';
        updateDeleteState();
      });
      confirmInput.addEventListener('input', updateDeleteState);
    }

    // Keep tuner_update / tuner_rename select in sync with initial loaded values
    try {
      const selUpdate = document.getElementById('tuner_update');
      const selRename = document.getElementById('tuner_rename');
      if (selUpdate && selRename) {
        selRename.value = selUpdate.value;
      }
    } catch (e) {}

    // Mode switching for Add Tuner form
    try {
    const standardFields = document.getElementById('standard-fields');
    const streamFields = document.getElementById('stream-fields');
    const combinedFields = document.getElementById('combined-fields');
    const xmlInput = document.getElementById('xml_new');
    const m3uInput = document.getElementById('m3u_new');
    const m3u8Input = document.getElementById('m3u8_stream');
    const sourceTunersSelect = document.getElementById('source_tuners');
    const modeRadios = document.querySelectorAll('input[name="tuner_mode"]');

    function updateFormMode() {
      const selectedMode = document.querySelector('input[name="tuner_mode"]:checked');
      const mode = selectedMode ? selectedMode.value : 'standard';

      // Hide all field groups first
      standardFields.style.display = 'none';
      streamFields.style.display = 'none';
      combinedFields.style.display = 'none';

      // Remove required from all optional inputs
      xmlInput.removeAttribute('required');
      m3uInput.removeAttribute('required');
      m3u8Input.removeAttribute('required');

      if (mode === 'single_stream') {
        streamFields.style.display = 'block';
        m3u8Input.setAttribute('required', 'required');
      } else if (mode === 'combined') {
        combinedFields.style.display = 'block';
        // source_tuners select is validated server-side; no HTML required attribute on multi-select
      } else {
        // Standard mode (default)
        standardFields.style.display = 'block';
        xmlInput.setAttribute('required', 'required');
        m3uInput.setAttribute('required', 'required');
      }
    }

    // Initialize mode on load
    updateFormMode();

    // Handle mode change
    modeRadios.forEach(radio => {
      radio.addEventListener('change', updateFormMode);
    });
  } catch (e) {
    // Log error if mode switching setup fails - form will still submit with default standard mode
    console.error('Mode switching initialization failed:', e);
  }
});

// Per-channel overlay prefs: toggle panels and handle reset buttons
document.querySelectorAll('.vc-prefs-btn').forEach(function (btn) {
  btn.addEventListener('click', function () {
    var panelId = btn.dataset.panel;
    var panel = document.getElementById(panelId);
    var expanded = btn.getAttribute('aria-expanded') === 'true';
    panel.hidden = expanded;
    btn.setAttribute('aria-expanded', String(!expanded));
    btn.textContent = expanded ? 'âš™ Overlay' : 'âš™ Overlay â–²';
  });
});

document.querySelectorAll('.vc-prefs-reset').forEach(function (btn) {
  btn.addEventListener('click', function () {
    var colorInput = btn.previousElementSibling;
    if (colorInput && colorInput.type === 'color') {
      colorInput.value = btn.dataset.default || '#ffffff';
    }
  });
});

// US Zip Code â†’ lat/lon/location auto-fill via zippopotam.us
(function () {
  var btn    = document.getElementById('vc-zip-lookup-btn');
  var zipEl  = document.getElementById('vc-zip-input');
  var latEl  = document.getElementById('vc-weather-lat');
  var lonEl  = document.getElementById('vc-weather-lon');
  var locEl  = document.getElementById('vc-weather-location');
  var status = document.getElementById('vc-zip-status');
  if (!btn || !zipEl) return;

  function doLookup() {
    var zip = zipEl.value.trim();
    if (!/^\d{5}$/.test(zip)) {
      status.textContent = 'Enter a 5-digit US zip code.';
      status.className = 'zip-status zip-status-error';
      return;
    }
    btn.disabled = true;
    status.textContent = 'Looking upâ€¦';
    status.className = 'zip-status';
    fetch('https://api.zippopotam.us/us/' + zip)
      .then(function (r) {
        if (!r.ok) throw new Error('not found');
        return r.json();
      })
      .then(function (data) {
        var place = data.places && data.places[0];
        if (!place) throw new Error('no places');
        var lat = parseFloat(place.latitude);
        var lon = parseFloat(place.longitude);
        if (isNaN(lat) || isNaN(lon)) throw new Error('invalid coords');
        var loc = place['place name'] + ', ' + place['state abbreviation'];
        latEl.value = lat.toFixed(4);
        lonEl.value = lon.toFixed(4);
        locEl.value = loc;
        status.textContent = 'âœ“ Found: ' + loc;
        status.className = 'zip-status zip-status-ok';
      })
      .catch(function () {
        status.textContent = 'Zip code not found.';
        status.className = 'zip-status zip-status-error';
      })
      .finally(function () {
        btn.disabled = false;
      });
  }

  btn.addEventListener('click', doLookup);
  zipEl.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') { e.preventDefault(); doLookup(); }
  });
})();
</script>
{% endblock %}
