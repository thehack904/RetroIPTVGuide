{% extends "base.html" %}
{% block title %}Change Tuner — IPTV Guide{% endblock %}

{% block page_styles %}
{# load the per-page stylesheet so the boxed/centered layout is applied #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/change_tuner.css') }}">
{% endblock %}

{% block content %}
<div class="container-change-tuner">
  <div class="box">
    <h2>Change Active Tuner</h2>
    <form method="POST">
        <input type="hidden" name="action" value="switch_tuner">
        <label for="tuner">Select Tuner:</label>
        <select name="tuner" id="tuner" required>
            {% for tuner in tuners %}
            <option value="{{ tuner }}" {% if tuner == current_tuner %}selected{% endif %}>{{ tuner }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="primary">Set Active Tuner</button>
    </form>
  </div>

  <div class="box">
    <h2>Update Tuner URLs</h2>
    <form method="POST">
        <input type="hidden" name="action" value="update_urls">
        <label for="tuner_update">Select Tuner:</label>
        <select name="tuner" id="tuner_update" required onchange="populateUrls(this.value)">
            {% for tuner in tuners %}
            <option value="{{ tuner }}">{{ tuner }}</option>
            {% endfor %}
        </select>
        <div class="form-row">
          <input type="text" name="xml_url" id="xml_url" placeholder="XML URL (.xml)" required>
        </div>
        <div class="form-row">
          <input type="text" name="m3u_url" id="m3u_url" placeholder="M3U URL (.m3u)" required>
        </div>
        <button type="submit" class="primary">Update URLs</button>
    </form>
  </div>

  <div class="box">
    <h2>Manage Tuners</h2>

    <!-- Add new tuner -->
    <form method="POST" style="margin-bottom:20px;">
        <input type="hidden" name="action" value="add_tuner">
        <div class="form-row"><input type="text" name="tuner_name" placeholder="New Tuner Name" required></div>
        <div class="form-row"><input type="text" name="xml_url" placeholder="XML URL (.xml)" required></div>
        <div class="form-row"><input type="text" name="m3u_url" placeholder="M3U URL (.m3u)" required></div>
        <button type="submit" class="primary">Add Tuner</button>
    </form>

    <!-- Remove existing tuner -->
    <form method="POST">
        <input type="hidden" name="action" value="delete_tuner">
        <label for="tuner_remove">Delete Tuner:</label>
        <select name="tuner" id="tuner_remove" required>
            {% for tuner in tuners %}
            {% if tuner != current_tuner %}
            <option value="{{ tuner }}">{{ tuner }}</option>
            {% endif %}
            {% endfor %}
        </select>
        <button type="submit" class="primary">Delete Tuner</button>
    </form>

  </div>

  <div class="box">
    <h2>Rename Tuner</h2>
    <form method="POST">
        <input type="hidden" name="action" value="rename_tuner">
        <label for="tuner_rename">Select Tuner:</label>
        <select name="tuner" id="tuner_rename" required>
            {% for tuner in tuners %}
            <option value="{{ tuner }}">{{ tuner }}</option>
            {% endfor %}
        </select>
        <div class="form-row">
          <input type="text" name="new_name" placeholder="New Tuner Name" required>
        </div>
        <button type="submit" class="primary">Rename</button>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
const tunerData = {{ TUNERS|tojson }};

function populateUrls(tuner) {
    if (tunerData && tunerData[tuner]) {
        document.getElementById('xml_url').value = tunerData[tuner].xml || "";
        document.getElementById('m3u_url').value = tunerData[tuner].m3u || "";
    } else {
        document.getElementById('xml_url').value = "";
        document.getElementById('m3u_url').value = "";
    }
}

document.addEventListener("DOMContentLoaded", () => {
    // Setup theme from storage (shared base handles most of it)
    const saved = localStorage.getItem("theme") || "dark";
    setTheme(saved);

    // Clock already initialized by base; ensure it updates here too
    updateClock();

    // Initialize update form with first tuner’s URLs if available
    const sel = document.getElementById('tuner_update');
    if (sel) {
      const firstTuner = sel.value;
      populateUrls(firstTuner);
    }
});
</script>
{% endblock %}
