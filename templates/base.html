<!doctype html>
<html>
<head>
    <title>{% block title %}IPTV Guide{% endblock %}</title>

    <!-- Responsive viewport: required for mobile layout stability -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <!-- Apply saved display size before paint to avoid layout flash.
         Injects a CSS rule that pre-scales #appZoomRoot before display-size.js (defer)
         runs, so there is no visible flash of unstyled/unscaled content. -->
    <script>
    (function () {
      try {
        var ds = localStorage.getItem('displaySize');
        if (ds && ds !== 'large') {
          document.documentElement.setAttribute('data-display-size', ds);
          // Zoom factors must stay in sync with ZOOM_PRESETS in display-size.js.
          // Duplication is intentional: this script runs synchronously before any
          // external scripts (including display-size.js) load, so it cannot import.
          var ZOOM = { medium: 0.8, small: 0.67 };
          var z = ZOOM[ds];
          if (z) {
            var wPx = Math.ceil(window.innerWidth  / z);
            var hPx = Math.ceil(window.innerHeight / z);
            var s = document.createElement('style');
            s.id = '__dsinit';
            s.textContent = '#appZoomRoot{transform:scale(' + z + ');transform-origin:top left;width:' + wPx + 'px;height:' + hPx + 'px}';
            document.head.appendChild(s);
          }
        }
      } catch (e) { /* ignore */ }
    })();
    </script>

    <!-- Small, immediate script to apply the saved theme before paint and provide a safe stub
         for setTheme so inline onclick handlers don't throw before the real script loads. -->
    <script>
    (function () {
      try {
        var t = localStorage.getItem('theme');
        if (t) {
          // Handle 'auto' theme
          if (t === 'auto') {
            // Detect system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
              t = 'dark';
            } else {
              t = 'light';
            }
          }
          document.documentElement.setAttribute('data-theme', t);
        } else {
          // No saved preference - auto-detect
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
          } else {
            document.documentElement.setAttribute('data-theme', 'light');
          }
        }
      } catch (e) { /* ignore */ }

      // temporary safe stub â€” will be replaced by /static/js/theme.js when it loads
      if (!window.setTheme) {
        window.setTheme = function (name) {
          try {
            if (name) {
              document.documentElement.setAttribute('data-theme', name);
            } else {
              document.documentElement.removeAttribute('data-theme');
            }
            try { localStorage.setItem('theme', name); } catch (e) {}
          } catch (e) { /* ignore */ }
        };
      }
    })();
    </script>

    <!-- global shared CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <!-- Mobile-specific overrides / responsive styles (loaded after base.css) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-submenu.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-scroll-fix.css') }}">

    {% block page_styles %}
    {# per-page CSS variables or small style blocks can be provided here #}
    {% endblock %}
</head>
<body>
    <div id="appZoomRoot">
    {% include '_header.html' %}

    {% block content %}
    <!-- Page-specific content goes here -->
    {% endblock %}
    </div><!-- #appZoomRoot -->

    <!-- shared scripts -->
    <script src="{{ url_for('static', filename='hls.js') }}"></script>
    <script src="{{ url_for('static', filename='js/clock-fix.js') }}" defer></script>

    <!-- Auto Scroll: make this block overridable so pages that don't need it (change_tuner)
         can remove the include by overriding the block to an empty block. -->
    {% block autoscroll_script %}
    <script src="{{ url_for('static', filename='js/auto-scroll-manager.js') }}" defer></script>
    {% endblock %}

    <!-- Mobile nav behavior -->
    <script src="{{ url_for('static', filename='js/mobile-nav.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/mobile-player-adapt.js') }}" defer></script>

    <!-- Theme script: included for all pages. Uses defer so it runs before DOMContentLoaded.
         It will replace the stub setTheme defined above with a fuller implementation. -->
    <script src="{{ url_for('static', filename='js/theme.js') }}" defer></script>
    <!-- Display size scaling (Large/Medium/Small) -->
    <script src="{{ url_for('static', filename='js/display-size.js') }}" defer></script>

    <!-- existing shared inline <script> content here (clock, helpers, etc) -->
    {% block scripts_extra %}
    {# per-page scripts can be placed here; theme.js is already included above so setTheme/applyTheme is available #}
    {% endblock %}
</body>
</html>
