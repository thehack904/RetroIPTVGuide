{% extends "base.html" %}
{% block title %}Manage Users â€” IPTV Guide{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/manage_users.css') }}">
{% endblock %}

{% block content %}
<div class="container-manage-users">
  <div class="box">
    <h2>Manage Users</h2>

    <form method="POST" class="add-user-form">
      <h3>Add New User</h3>
      <input type="hidden" name="action" value="add">
      <div class="form-row"><input type="text" name="username" placeholder="Username" required></div>
      <div class="form-row"><input type="password" name="password" placeholder="Password" required></div>
      <div class="form-row"><button class="btn add" type="submit">Add User</button></div>
    </form>

    <h3>Existing Users</h3>
    <div class="table-wrap">
      <table class="users-table">
          <thead>
            <tr><th>Username</th><th>Last Login</th><th>Assigned Tuner</th><th>Actions</th></tr>
          </thead>
          <tbody>
            {% for user in users %}
            <tr>
              <td>{{ user.username }}</td>
              <td>{{ user.last_login | format_datetime }}</td>
              <td>
                <form method="POST" class="inline-form assign-tuner-form">
                  <input type="hidden" name="username" value="{{ user.username }}">
                  <input type="hidden" name="action" value="assign_tuner">
                  <select name="tuner_name" title="Assign tuner to {{ user.username }}">
                    <option value="">â€” No specific tuner â€”</option>
                    {% for t in tuner_names %}
                    <option value="{{ t }}" {% if user.assigned_tuner == t %}selected{% endif %}>{{ t }}</option>
                    {% endfor %}
                  </select>
                  <button class="btn add" type="submit">Assign</button>
                </form>
              </td>
              <td class="actions">
                <form method="POST" class="inline-form">
                  <input type="hidden" name="username" value="{{ user.username }}">
                  <input type="hidden" name="action" value="delete">
                  <button class="btn danger" type="submit">Delete</button>
                </form>
                <form method="POST" class="inline-form">
                  <input type="hidden" name="username" value="{{ user.username }}">
                  <input type="hidden" name="action" value="signout">
                  <button class="btn warn" type="submit">Sign Out All</button>
                </form>
                <button class="btn prefs-toggle" type="button"
                        onclick="togglePrefsPanel('{{ user.username }}')">âš™ Prefs</button>
              </td>
            </tr>
            <!-- Expandable channel preferences panel for {{ user.username }} -->
            <tr id="prefs-panel-{{ user.username }}" class="prefs-panel-row" style="display:none">
              <td colspan="4">
                <form method="POST" class="prefs-form">
                  <input type="hidden" name="action" value="set_user_prefs">
                  <input type="hidden" name="username" value="{{ user.username }}">

                  <div class="prefs-form-grid">
                    <!-- Auto-load channel -->
                    <div class="prefs-field">
                      <label for="auto-load-{{ user.username }}">ðŸ“Œ Auto-Load Channel</label>
                      <select id="auto-load-{{ user.username }}" name="auto_load_channel_id">
                        <option value="">â€” None (no auto-load) â€”</option>
                        {% for ch in channel_list %}
                        <option value="{{ ch.id }}"
                          {% if user.prefs.auto_load_channel and user.prefs.auto_load_channel.id == ch.id %}selected{% endif %}>
                          {{ ch.name }}
                        </option>
                        {% endfor %}
                      </select>
                      {% if not channel_list %}
                      <small class="prefs-hint">No channels loaded â€” switch to the guide first to populate the list.</small>
                      {% endif %}
                    </div>

                    <!-- Sizzle reels -->
                    <div class="prefs-field">
                      <label class="prefs-checkbox-label">
                        <input type="checkbox" name="sizzle_reels_enabled" value="1"
                               {% if user.prefs.sizzle_reels_enabled %}checked{% endif %}>
                        ðŸŽ¬ Sizzle Reels (hover preview)
                      </label>
                    </div>

                    <!-- Hidden channels -->
                    <div class="prefs-field prefs-hidden-channels">
                      <label>ðŸ™ˆ Hidden Channels</label>
                      {% if user.prefs.hidden_channels %}
                      <ul class="hidden-ch-list">
                        {% for cid in user.prefs.hidden_channels %}
                        <li>{{ cid }}</li>
                        {% endfor %}
                      </ul>
                      <label class="prefs-checkbox-label">
                        <input type="checkbox" name="clear_hidden" value="1">
                        Clear all hidden channels
                      </label>
                      {% else %}
                      <span class="prefs-hint">No hidden channels.</span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="prefs-form-actions">
                    <button class="btn add" type="submit">Save Preferences</button>
                  </div>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
      </table>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-messages">
          {% for msg in messages %}
            <p class="flash">{{ msg }}</p>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
function togglePrefsPanel(username) {
  const row = document.getElementById('prefs-panel-' + username);
  if (!row) return;
  row.style.display = (row.style.display === 'none' || row.style.display === '') ? 'table-row' : 'none';
}

document.addEventListener("DOMContentLoaded", () => {
  // Apply saved theme (base.html provides setTheme/updateClock)
  const saved = localStorage.getItem("theme") || "dark";
  if (typeof setTheme === 'function') setTheme(saved);
  if (typeof updateClock === 'function') updateClock();
});
</script>
{% endblock %}
