{% extends "base.html" %}
{% block title %}Activity Log â€” IPTV Guide{% endblock %}

{% block page_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/logs.css') }}">
{% endblock %}

{% block content %}
<div class="container-logs">
  <div class="box">
    <h2>Activity Log ({{ log_size }} bytes)</h2>

    <!-- Clear Logs button -->
    <form method="POST" action="{{ url_for('clear_logs') }}" class="clear-form">
      <button type="submit" class="btn-clear">Clear Logs</button>
    </form>

    <!-- Search bar -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search logs..." onkeyup="searchLogs()">
    </div>

    <!-- Filter bar -->
    <div class="filter-bar">
      <button type="button" class="filter-btn" onclick="filterLogs('all')">All</button>
      <button type="button" class="filter-btn" onclick="filterLogs('activity')">Activity</button>
      <button type="button" class="filter-btn" onclick="filterLogs('security')">Security</button>
    </div>

    <div class="table-wrap">
      <table id="logsTable" class="logs-table">
          <thead>
              <tr><th>User</th><th>Action</th><th>Timestamp</th></tr>
          </thead>
          <tbody>
              {% for user, action, ts, log_type in entries %}
              <tr class="{{ log_type }}">
                  <td>{{ user }}</td>
                  <td>{{ action }}</td>
                  <td>{{ ts }}</td>
              </tr>
              {% endfor %}
          </tbody>
      </table>
    </div>

    <!-- Pagination controls -->
    <div class="pagination-controls">
      <button type="button" class="page-btn" id="prevBtn" onclick="changePage(-1)">Previous</button>
      <span id="pageInfo" class="page-info">Page 1</span>
      <button type="button" class="page-btn" id="nextBtn" onclick="changePage(1)">Next</button>
      <select id="pageSizeSelect" onchange="changePageSize()">
        <option value="10">10 per page</option>
        <option value="25" selected>25 per page</option>
        <option value="50">50 per page</option>
        <option value="100">100 per page</option>
      </select>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
// Pagination and filtering state
let currentPage = 1;
let pageSize = 25;
let currentFilter = 'all';
let searchQuery = '';

document.addEventListener("DOMContentLoaded", () => {
    // Apply saved theme (base.html provides setTheme/updateClock)
    const saved = localStorage.getItem("theme") || "dark";
    if (typeof setTheme === 'function') setTheme(saved);
    if (typeof updateClock === 'function') updateClock();
    setInterval(() => { if (typeof updateClock === 'function') updateClock(); }, 1000);
    
    // Initialize pagination
    applyPaginationAndFilters();
});

// Search function
function searchLogs() {
    searchQuery = document.getElementById('searchInput').value.toLowerCase();
    currentPage = 1; // Reset to first page on search
    applyPaginationAndFilters();
}

// Filter function (updated to work with pagination)
function filterLogs(type) {
    currentFilter = type;
    currentPage = 1; // Reset to first page on filter change
    applyPaginationAndFilters();
}

// Change page
function changePage(delta) {
    const allRows = Array.from(document.querySelectorAll("#logsTable tbody tr"));
    const filteredRows = getFilteredRows(allRows);
    const totalPages = Math.ceil(filteredRows.length / pageSize);
    
    currentPage += delta;
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages) currentPage = totalPages;
    
    applyPaginationAndFilters();
}

// Change page size
function changePageSize() {
    pageSize = parseInt(document.getElementById('pageSizeSelect').value);
    currentPage = 1; // Reset to first page
    applyPaginationAndFilters();
}

// Get filtered rows based on current filters and search
function getFilteredRows(rows) {
    return rows.filter(row => {
        // Apply type filter
        if (currentFilter !== 'all' && !row.classList.contains(currentFilter)) {
            return false;
        }
        
        // Apply search filter
        if (searchQuery) {
            const text = row.textContent.toLowerCase();
            if (!text.includes(searchQuery)) {
                return false;
            }
        }
        
        return true;
    });
}

// Apply both pagination and filters
function applyPaginationAndFilters() {
    const allRows = Array.from(document.querySelectorAll("#logsTable tbody tr"));
    const filteredRows = getFilteredRows(allRows);
    const totalPages = Math.ceil(filteredRows.length / pageSize) || 1;
    
    // Ensure currentPage is within bounds
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;
    
    const startIdx = (currentPage - 1) * pageSize;
    const endIdx = startIdx + pageSize;
    
    // Hide all rows first
    allRows.forEach(row => {
        row.style.display = 'none';
    });
    
    // Show only the rows for current page
    filteredRows.forEach((row, idx) => {
        if (idx >= startIdx && idx < endIdx) {
            row.style.display = '';
        }
    });
    
    // Update pagination controls
    document.getElementById('pageInfo').textContent = 
        `Page ${currentPage} of ${totalPages} (${filteredRows.length} entries)`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage === totalPages;
}
</script>
{% endblock %}
