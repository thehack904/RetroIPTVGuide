<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RetroIPTV Weather</title>
  <style>
    /* ── Reset & Base ─────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: Arial, Helvetica, sans-serif;
      background: #0a1a6e;
      color: #fff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* ── Outer frame ─────────────────────────────────────────────── */
    .wx-frame {
      width: min(1280px, 100vw);
      aspect-ratio: 16 / 9;
      background: linear-gradient(160deg, #1030c8 0%, #0a1a80 40%, #081060 100%);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    /* subtle scanline vignette */
    .wx-frame::after {
      content: '';
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 3px,
          rgba(0,0,0,0.06) 3px,
          rgba(0,0,0,0.06) 4px
        );
      pointer-events: none;
      z-index: 10;
    }

    /* ── Header bar ─────────────────────────────────────────────── */
    .wx-header {
      background: linear-gradient(90deg, #0d2aaa 0%, #1640d4 50%, #0d2aaa 100%);
      border-bottom: 3px solid #4a70ff;
      padding: 0.6em 1.2em;
      display: flex;
      align-items: center;
      gap: 1em;
      flex-shrink: 0;
    }

    .wx-header-title {
      font-size: clamp(22px, 3.5vw, 46px);
      font-weight: 900;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 0.3em;
    }

    .wx-header-title .wx-icon-header {
      font-size: 1.1em;
    }

    .wx-header-subtitle {
      font-size: clamp(18px, 2.8vw, 38px);
      font-weight: 900;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #fff;
      margin-left: auto;
    }

    .wx-updated {
      font-size: clamp(11px, 1.5vw, 18px);
      font-weight: 700;
      color: #ffd700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.2em 1.2em 0;
      flex-shrink: 0;
    }

    /* ── Main content area ──────────────────────────────────────── */
    .wx-body {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 2.2fr;
      grid-template-rows: 1fr auto;
      gap: 0.5em;
      padding: 0.5em 0.7em 0.3em;
      min-height: 0;
    }

    /* ── Section box ─────────────────────────────────────────────── */
    .wx-box {
      background: rgba(10, 40, 170, 0.75);
      border: 2px solid #3058d8;
      border-radius: 4px;
      padding: 0.5em 0.7em;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.1), 0 2px 8px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }

    .wx-box-title {
      font-size: clamp(11px, 1.4vw, 17px);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #c8d8ff;
      border-bottom: 1px solid #3058d8;
      padding-bottom: 0.3em;
      margin-bottom: 0.4em;
    }

    /* ── Current Conditions (left column) ──────────────────────── */
    .wx-current {
      grid-column: 1;
      grid-row: 1;
    }

    .wx-current-icon {
      font-size: clamp(48px, 7vw, 90px);
      line-height: 1;
      text-align: center;
      margin: 0.1em 0;
    }

    .wx-current-temp {
      font-size: clamp(36px, 5.5vw, 72px);
      font-weight: 900;
      text-align: center;
      line-height: 1;
      margin: 0.1em 0;
    }

    .wx-current-cond {
      font-size: clamp(13px, 1.6vw, 22px);
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.4em;
    }

    .wx-current-details {
      font-size: clamp(10px, 1.2vw, 15px);
      line-height: 1.7;
      color: #d0e0ff;
      margin-top: auto;
    }

    /* ── Today's Forecast (right column, top) ─────────────────── */
    .wx-today {
      grid-column: 2;
      grid-row: 1;
    }

    .wx-today-cols {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      flex: 1;
      gap: 0;
      height: 100%;
    }

    .wx-period {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.2em 0.4em;
    }

    .wx-period + .wx-period {
      border-left: 1px solid #3058d8;
    }

    .wx-period-label {
      font-size: clamp(10px, 1.35vw, 17px);
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #c8d8ff;
      margin-bottom: 0.2em;
    }

    .wx-period-icon {
      font-size: clamp(32px, 4.5vw, 60px);
      line-height: 1;
      margin: 0.15em 0;
    }

    .wx-period-temp {
      font-size: clamp(26px, 3.8vw, 52px);
      font-weight: 900;
      line-height: 1;
    }

    .wx-period-cond {
      font-size: clamp(10px, 1.2vw, 14px);
      font-weight: 700;
      text-align: center;
      margin-top: 0.2em;
      color: #d0e0ff;
    }

    /* ── Extended Outlook (bottom row, spans full width) ────────── */
    .wx-extended {
      grid-column: 1 / -1;
      grid-row: 2;
    }

    .wx-extended .wx-box-title {
      color: #40c0ff;
    }

    .wx-ext-cols {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0;
    }

    .wx-ext-day {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.2em 0.4em;
    }

    .wx-ext-day + .wx-ext-day {
      border-left: 1px solid #3058d8;
    }

    .wx-ext-dow {
      font-size: clamp(11px, 1.5vw, 18px);
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: #c8d8ff;
    }

    .wx-ext-icon {
      font-size: clamp(24px, 3.2vw, 44px);
      line-height: 1;
      margin: 0.1em 0;
    }

    .wx-ext-temps {
      font-size: clamp(12px, 1.6vw, 20px);
      font-weight: 900;
    }

    .wx-ext-cond {
      font-size: clamp(9px, 1.1vw, 13px);
      font-weight: 700;
      color: #d0e0ff;
      text-align: center;
    }

    /* ── Breaking News Ticker ───────────────────────────────────── */
    .wx-ticker-bar {
      background: #0a0e2a;
      border-top: 2px solid #4a70ff;
      display: flex;
      align-items: center;
      overflow: hidden;
      flex-shrink: 0;
      height: clamp(28px, 4vw, 46px);
    }

    .wx-ticker-label {
      background: #ffd700;
      color: #0a0e2a;
      font-size: clamp(10px, 1.4vw, 17px);
      font-weight: 900;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 0 0.7em;
      white-space: nowrap;
      height: 100%;
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    .wx-ticker-scroll {
      overflow: hidden;
      flex: 1;
      height: 100%;
      display: flex;
      align-items: center;
    }

    .wx-ticker-track {
      display: inline-block;
      white-space: nowrap;
      font-size: clamp(10px, 1.35vw, 16px);
      font-weight: 700;
      color: #ffd700;
      animation: wx-scroll 28s linear infinite;
      padding-left: 100%;
    }

    @keyframes wx-scroll {
      from { transform: translateX(0); }
      to   { transform: translateX(-100%); }
    }

    /* ── Loading / error state ──────────────────────────────────── */
    .wx-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      font-size: clamp(14px, 2vw, 24px);
      color: #90a8f0;
      letter-spacing: 0.1em;
    }

    /* ── Weather icon SVGs (inline, reused via CSS class) ─────── */
    .wx-svg { display: inline-block; vertical-align: middle; }
  </style>
</head>
<body>
<div class="wx-frame" id="wxFrame">
  <div class="wx-loading" id="wxLoading">Loading weather…</div>
</div>

<!-- Inline SVG icon definitions (referenced by id) -->
<svg width="0" height="0" style="position:absolute">
  <defs>
    <!-- Sun -->
    <symbol id="icon-sunny" viewBox="0 0 64 64">
      <circle cx="32" cy="32" r="13" fill="#ffd700" stroke="#ffb300" stroke-width="1.5"/>
      <g stroke="#ffd700" stroke-width="2.5" stroke-linecap="round">
        <line x1="32" y1="4"  x2="32" y2="11"/>
        <line x1="32" y1="53" x2="32" y2="60"/>
        <line x1="4"  y1="32" x2="11" y2="32"/>
        <line x1="53" y1="32" x2="60" y2="32"/>
        <line x1="12" y1="12" x2="17" y2="17"/>
        <line x1="47" y1="47" x2="52" y2="52"/>
        <line x1="52" y1="12" x2="47" y2="17"/>
        <line x1="17" y1="47" x2="12" y2="52"/>
      </g>
    </symbol>
    <!-- Partly Cloudy (sun + cloud) -->
    <symbol id="icon-partly_cloudy" viewBox="0 0 64 64">
      <circle cx="24" cy="22" r="11" fill="#ffd700" stroke="#ffb300" stroke-width="1.5"/>
      <g stroke="#ffd700" stroke-width="2" stroke-linecap="round">
        <line x1="24" y1="4"  x2="24" y2="9"/>
        <line x1="24" y1="35" x2="24" y2="38"/>
        <line x1="6"  y1="22" x2="11" y2="22"/>
        <line x1="37" y1="22" x2="42" y2="22"/>
        <line x1="10" y1="10" x2="14" y2="14"/>
        <line x1="34" y1="30" x2="38" y2="34"/>
        <line x1="38" y1="10" x2="34" y2="14"/>
        <line x1="14" y1="30" x2="10" y2="34"/>
      </g>
      <rect x="14" y="36" width="36" height="14" rx="7" fill="#d0deff"/>
      <rect x="22" y="28" width="24" height="14" rx="7" fill="#e8eeff"/>
      <rect x="14" y="36" width="36" height="14" rx="7" fill="#c0d0f0"/>
    </symbol>
    <!-- Cloudy -->
    <symbol id="icon-cloudy" viewBox="0 0 64 64">
      <rect x="8"  y="32" width="48" height="18" rx="9" fill="#c0d0f0"/>
      <rect x="16" y="22" width="32" height="18" rx="9" fill="#d8e4ff"/>
      <rect x="8"  y="32" width="48" height="18" rx="9" fill="#b0c4e8"/>
    </symbol>
    <!-- Night (moon + cloud) -->
    <symbol id="icon-partly_cloudy_night" viewBox="0 0 64 64">
      <path d="M34 8 C24 10 18 20 22 30 C26 40 38 42 46 36 C40 40 28 38 24 28 C20 18 28 8 34 8Z" fill="#c8b44a" stroke="#a89030" stroke-width="1"/>
      <rect x="14" y="36" width="36" height="14" rx="7" fill="#d0deff"/>
      <rect x="22" y="28" width="24" height="14" rx="7" fill="#e8eeff"/>
      <rect x="14" y="36" width="36" height="14" rx="7" fill="#c0d0f0"/>
    </symbol>
    <!-- Cloudy night -->
    <symbol id="icon-cloudy_night" viewBox="0 0 64 64">
      <path d="M28 6 C18 8 12 18 16 28 C20 38 32 40 40 34 C34 38 22 36 18 26 C14 16 22 6 28 6Z" fill="#c8b44a" stroke="#a89030" stroke-width="1"/>
      <rect x="8"  y="32" width="48" height="18" rx="9" fill="#b0c4e8"/>
      <rect x="16" y="22" width="32" height="18" rx="9" fill="#c8d8f8"/>
    </symbol>
    <!-- Rain -->
    <symbol id="icon-rain" viewBox="0 0 64 64">
      <rect x="8"  y="18" width="48" height="16" rx="8" fill="#b0c4e8"/>
      <rect x="16" y="10" width="32" height="16" rx="8" fill="#c8d8f8"/>
      <g stroke="#4488cc" stroke-width="2.5" stroke-linecap="round">
        <line x1="20" y1="40" x2="18" y2="52"/>
        <line x1="32" y1="40" x2="30" y2="52"/>
        <line x1="44" y1="40" x2="42" y2="52"/>
      </g>
    </symbol>
    <!-- Showers -->
    <symbol id="icon-showers" viewBox="0 0 64 64">
      <circle cx="24" cy="16" r="9"  fill="#ffd700" stroke="#ffb300" stroke-width="1.5"/>
      <rect x="18" y="24" width="32" height="14" rx="7" fill="#b0c4e8"/>
      <rect x="26" y="16" width="20" height="12" rx="6" fill="#c8d8f8"/>
      <g stroke="#4488cc" stroke-width="2.5" stroke-linecap="round">
        <line x1="24" y1="44" x2="22" y2="56"/>
        <line x1="36" y1="44" x2="34" y2="56"/>
        <line x1="48" y1="44" x2="46" y2="56"/>
      </g>
    </symbol>
    <!-- Thunderstorm -->
    <symbol id="icon-thunderstorm" viewBox="0 0 64 64">
      <rect x="8"  y="12" width="48" height="16" rx="8" fill="#8090b0"/>
      <rect x="16" y="6"  width="32" height="14" rx="7" fill="#a0b0c8"/>
      <polygon points="34,28 26,44 32,44 28,58 42,38 36,38" fill="#ffd700"/>
    </symbol>
    <!-- Drizzle -->
    <symbol id="icon-drizzle" viewBox="0 0 64 64">
      <rect x="8"  y="18" width="48" height="16" rx="8" fill="#b0c4e8"/>
      <rect x="16" y="10" width="32" height="16" rx="8" fill="#c8d8f8"/>
      <g stroke="#88aadd" stroke-width="2" stroke-linecap="round">
        <line x1="20" y1="40" x2="19" y2="48"/>
        <line x1="28" y1="42" x2="27" y2="50"/>
        <line x1="36" y1="40" x2="35" y2="48"/>
        <line x1="44" y1="42" x2="43" y2="50"/>
      </g>
    </symbol>
    <!-- Snow -->
    <symbol id="icon-snow" viewBox="0 0 64 64">
      <rect x="8"  y="14" width="48" height="16" rx="8" fill="#b0c4e8"/>
      <rect x="16" y="6"  width="32" height="16" rx="8" fill="#c8d8f8"/>
      <g fill="#d0e8ff">
        <circle cx="20" cy="46" r="3"/>
        <circle cx="32" cy="44" r="3"/>
        <circle cx="44" cy="46" r="3"/>
        <circle cx="26" cy="54" r="2.5"/>
        <circle cx="38" cy="54" r="2.5"/>
      </g>
    </symbol>
    <!-- Foggy -->
    <symbol id="icon-foggy" viewBox="0 0 64 64">
      <rect x="8"  y="12" width="48" height="10" rx="5" fill="#b0bcd0" opacity="0.8"/>
      <rect x="12" y="26" width="40" height="8"  rx="4" fill="#a8b8cc" opacity="0.8"/>
      <rect x="8"  y="38" width="48" height="8"  rx="4" fill="#98a8bc" opacity="0.7"/>
      <rect x="14" y="50" width="36" height="8"  rx="4" fill="#8898ac" opacity="0.6"/>
    </symbol>
  </defs>
</svg>

<script>
(function () {
  'use strict';

  // Icon key → SVG symbol id
  const ICON_MAP = {
    sunny:               'icon-sunny',
    partly_cloudy:       'icon-partly_cloudy',
    partly_cloudy_night: 'icon-partly_cloudy_night',
    cloudy:              'icon-cloudy',
    cloudy_night:        'icon-cloudy_night',
    rain:                'icon-rain',
    showers:             'icon-showers',
    thunderstorm:        'icon-thunderstorm',
    drizzle:             'icon-drizzle',
    snow:                'icon-snow',
    foggy:               'icon-foggy',
  };

  function iconSvg(key, size) {
    const sym = ICON_MAP[key] || 'icon-cloudy';
    return `<svg class="wx-svg" width="${size}" height="${size}"><use href="#${sym}"/></svg>`;
  }

  function tempStr(t) {
    return (t != null) ? `${t}°` : '--°';
  }

  function formatLocalTime(isoStr) {
    try {
      return new Date(isoStr).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    } catch (e) { return isoStr; }
  }

  function build(data) {
    const frame = document.getElementById('wxFrame');
    const now   = data.now   || {};
    const today = Array.isArray(data.today)    ? data.today    : [];
    const ext   = Array.isArray(data.extended) ? data.extended : [];
    const ticks = Array.isArray(data.ticker)   ? data.ticker   : [];

    // ── determine icon sizes relative to frame width ──────────
    const fw = frame.offsetWidth || 960;
    const iconLg  = Math.round(fw * 0.10);
    const iconMd  = Math.round(fw * 0.08);
    const iconSm  = Math.round(fw * 0.06);

    // ── Today periods ──────────────────────────────────────────
    const periodCols = today.map(p => `
      <div class="wx-period">
        <div class="wx-period-label">${p.label || ''}</div>
        <div class="wx-period-icon">${iconSvg(p.icon, iconMd)}</div>
        <div class="wx-period-temp">${tempStr(p.temp)}</div>
        <div class="wx-period-cond">${p.condition || ''}</div>
      </div>`).join('');

    // ── Extended days ──────────────────────────────────────────
    const extCols = ext.map(d => `
      <div class="wx-ext-day">
        <div class="wx-ext-dow">${d.dow || ''}</div>
        <div class="wx-ext-icon">${iconSvg(d.icon, iconSm)}</div>
        <div class="wx-ext-temps">${tempStr(d.hi)} <span style="opacity:.7">${tempStr(d.lo)}</span></div>
        <div class="wx-ext-cond">${d.condition || ''}</div>
      </div>`).join('');

    // ── Ticker text ────────────────────────────────────────────
    const tickText = ticks.length
      ? ticks.join(' \u2022 ') + ' \u2022 '
      : 'No active weather alerts \u2022 ';
    const tickRepeat = tickText.repeat(3);

    // ── Current details ────────────────────────────────────────
    const details = [];
    if (now.humidity != null) details.push(`- Humid: ${now.humidity}%`);
    if (now.wind)              details.push(`- Wind: ${now.wind}`);
    if (now.feels_like != null) details.push(`- Feels Like: ${now.feels_like}°`);

    const html = `
      <!-- Header -->
      <div class="wx-header">
        <div class="wx-header-title">
          <span>RetroIPTV</span>
          <span class="wx-icon-header">${iconSvg('partly_cloudy', Math.round(fw * 0.055))}</span>
          <span>Weather</span>
        </div>
        <div class="wx-header-subtitle">Local Forecast</div>
      </div>
      <!-- Updated timestamp / location row -->
      <div class="wx-updated">
        <span>${data.location || ''}</span>
        <span>UPDATED: ${data.updated ? formatLocalTime(data.updated) : ''}</span>
      </div>
      <!-- Body grid -->
      <div class="wx-body">
        <!-- Current Conditions -->
        <div class="wx-box wx-current">
          <div class="wx-box-title">Current Conditions</div>
          <div class="wx-current-icon">${iconSvg(now.icon || 'cloudy', iconLg)}</div>
          <div class="wx-current-temp">${tempStr(now.temp)}</div>
          <div class="wx-current-cond">${now.condition || ''}</div>
          <div class="wx-current-details">${details.join('<br>')}</div>
        </div>
        <!-- Today's Forecast -->
        <div class="wx-box wx-today">
          <div class="wx-box-title">Today's Forecast</div>
          <div class="wx-today-cols">${periodCols}</div>
        </div>
        <!-- Extended Outlook -->
        <div class="wx-box wx-extended">
          <div class="wx-box-title">Extended Outlook</div>
          <div class="wx-ext-cols">${extCols || '<div style="color:#90a8f0;padding:.4em">No extended forecast available.</div>'}</div>
        </div>
      </div>
      <!-- Breaking News Ticker -->
      <div class="wx-ticker-bar">
        <div class="wx-ticker-label">Breaking News:</div>
        <div class="wx-ticker-scroll">
          <span class="wx-ticker-track">${tickRepeat}</span>
        </div>
      </div>`;

    frame.innerHTML = html;
  }

  // ── Background music ────────────────────────────────────────────
  let _musicEl = null;
  let _currentMusicSrc = '';

  function applyMusic(musicFile) {
    if (!musicFile) {
      if (_musicEl) { _musicEl.pause(); _musicEl.src = ''; }
      _currentMusicSrc = '';
      return;
    }
    if (musicFile === _currentMusicSrc) return;  // already playing this track
    _currentMusicSrc = musicFile;
    if (!_musicEl) {
      _musicEl = document.createElement('audio');
      _musicEl.loop = true;
      _musicEl.volume = 0.5;
      document.body.appendChild(_musicEl);
    }
    _musicEl.src = musicFile;
    _musicEl.play().catch(function () {
      // Autoplay blocked; resume on first user interaction
      function resumeOnInteraction() {
        _musicEl.play().catch(function () {});
      }
      document.addEventListener('click',   resumeOnInteraction, { once: true });
      document.addEventListener('keydown', resumeOnInteraction, { once: true });
    });
  }

  async function load() {
    try {
      const resp = await fetch('/api/weather');
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();
      build(data);
      applyMusic(data.music_file || '');
    } catch (e) {
      const frame = document.getElementById('wxFrame');
      frame.innerHTML = `<div class="wx-loading">Unable to load weather data.</div>`;
    }
  }

  load();
  setInterval(load, 5 * 60 * 1000);   // refresh every 5 minutes
})();
</script>
</body>
</html>
