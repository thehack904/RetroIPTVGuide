<!doctype html>
<html>
<head>
    <title>Live TV Guide</title>
    <style>
        /* Header + menus */
        body { font-family: Arial, sans-serif; margin:0; }
        .header { background:#222; height:40px; display:flex; justify-content:space-between; align-items:center; padding:0 10px; }
        .header .links { display:flex; align-items:center; height:100%; gap:10px; }
        .header .links > a, .header .links > .dropdown > .dropbtn, .header .links > span, .header .links > div#clock {
            display:flex; align-items:center; justify-content:center; padding:0 12px;
            color:#eee; font-weight:bold; text-decoration:none; height:40px; line-height:40px;
        }
        .header .links > a:hover, .header .links > .dropdown:hover > .dropbtn { background:#111; color:#0af; }
        .dropdown { position:relative; }
        .dropbtn { background:none; border:none; font:inherit; color:inherit; cursor:pointer; }
        .dropdown-content {
            display:none; position:absolute; top:100%; left:0; background:#333; min-width:180px;
            border-radius:3px; box-shadow:0 4px 6px rgba(0,0,0,0.3);
        }
        .dropdown-content a { padding:10px 14px; display:block; color:#eee; text-decoration:none; }
        .dropdown-content a:hover { background:#0af; color:#fff; }
        .dropdown:hover .dropdown-content { display:block; }

        /* Submenu (fly-out for Themes) */
        .submenu {
            position: relative;
        }
        .submenu > a {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .submenu-content {
            display: none;
            position: absolute;
            top: 0;
            left: 100%; /* fly out to the right */
            background-color: #333;
            min-width: 160px;
            border-radius: 3px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .submenu-content li a {
            padding: 10px 14px;
            display: block;
            color: #eee;
            text-decoration: none;
        }
        .submenu-content li a:hover {
            background-color: #0af;
            color: #fff;
        }
        .submenu:hover .submenu-content {
            display: block;
        }

		/* Remove default list bullets and padding for all dropdowns & submenus */
		.dropdown-content,
		.submenu ul,
		.submenu-content {
		    list-style: none;
		    margin: 0;
		    padding: 0;
		}

        /* Player row: Program Info (left) | Video (right) */
        .player { display:flex; gap:16px; padding:12px; }
        .summary { flex:1; }
        #video  { width:620px; height:350px; }

        /* Guide grid */
        .guide-outer { 
            height: calc(100vh - 420px); 
            overflow-y: auto; 
            padding-bottom: 80px;
        }
        .guide-row { display:flex; }
        .chan-col  { width: 200px; flex-shrink:0; border-right:1px solid; position: relative; z-index: 2; }
        .grid-col  { position:relative; flex:1; overflow-x:auto; overflow-y:visible; z-index:1; }
        .chan-header { height: 34px; border-bottom:1px solid; position:sticky; top:0; z-index:5; }
        .time-header-wrap { position:sticky; top:0; z-index:6; border-bottom:1px solid; }
        .time-header { display:flex; height:34px; align-items:center; }
        .time-cell { flex:0 0 {{ 30*SCALE }}px; width:{{ 30*SCALE }}px; text-align:center; border-right:1px solid; font-weight:600; }
        .chan-name { 
	    padding: 10px; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
	    gap: 6px; border-bottom: 1px solid;  cursor: pointer; position: relative;  z-index: 10; pointer-events: auto; user-select: none;
        }
        .chan-name img { width:36px; height:36px; object-fit:contain; margin-bottom: 4px; }
        .grid-row  { position:relative; height:60px; border-bottom:1px solid; }
        .grid-content { position:relative; width: {{ total_width }}px; min-height:100%; }
        .program { position:absolute; top:6px; height:48px; border:1px solid; padding:4px 6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
                   font-size:12px; border-radius:6px; }
        .program.now { font-weight:bold; }
        .now-line { position:absolute; top:0; bottom:0; width:2px; z-index:8; pointer-events:none; left: {{ now_offset }}px; }

        /* Dark theme */
        body.dark { background:#111; color:#ddd; }
        body.dark .header { background:#222; }
        body.dark #video { background:#000; }
        body.dark .summary { color:#ccc; }
        body.dark .chan-col { background:#1a1a1a; border-color:#333; }
        body.dark .grid-col { background:#181818; }
        body.dark .chan-header, body.dark .time-header-wrap { background:#222; border-color:#444; }
        body.dark .time-cell { color:#bbb; border-color:#333; }
        body.dark .chan-name { color:#fff; border-color:#333; }
        body.dark .program { background:#3a3a3a; border-color:#555; color:#eee; }
        body.dark .program.now { background:#2d5030; border-color:#47a447; }
        body.dark .now-line { background:#0f0; }

        /* Light theme */
        body.light { background:#fff; color:#000; }
        body.light .header { background:#222; }
        body.light #video { background:#fff; }
        body.light .summary { color:#000; }
        body.light .chan-col { background:#f9f9f9; border-color:#ccc; }
        body.light .grid-col { background:#fafafa; }
        body.light .chan-header, body.light .time-header-wrap { background:#ddd; border-color:#bbb; }
        body.light .time-cell { color:#000; border-color:#ccc; }
        body.light .chan-name { color:#000; border-color:#ccc; }
        body.light .program { background:#ddd; border-color:#aaa; color:#000; }
        body.light .program.now { background:#cfe8cf; border-color:#090; }
        body.light .now-line { background:#090; }
		
		/* Retro 90s TV Guide theme */
		body.retro-tvguide { background:#f2f2f2; color:#000; font-family:"Arial Black","Helvetica",sans-serif; }
		body.retro-tvguide .header { background:#cc0000; color:#fff; }
		body.retro-tvguide #video { background:#000; }
		body.retro-tvguide .summary { color:#111; }
		body.retro-tvguide .chan-col { background:#e6e6e6; border-color:#cc0000; }
		body.retro-tvguide .grid-col { background:#f9f9f9; }
		body.retro-tvguide .chan-header,
		body.retro-tvguide .time-header-wrap { background:#cc0000; color:#fff; border-color:#990000; }
		body.retro-tvguide .time-cell { color:#000; border-color:#bbb; }
		body.retro-tvguide .chan-name { color:#000; border-color:#cc0000; font-weight:bold; }
		body.retro-tvguide .program { background:#fff; border-color:#cc0000; color:#000; }
		body.retro-tvguide .program.now { background:#cc0000; border-color:#990000; color:#fff; font-weight:bold; }
		body.retro-tvguide .now-line { background:#ff0000; } /* bright red NOW line */
		
		/* Retro AOL / CompuServe Theme */
		body.retro-aol { background:#2f4f4f; color:#f0f0f0; font-family:"Tahoma","Arial",sans-serif; }
		body.retro-aol .header { background:#004466; color:#ffcc00; border-bottom:2px solid #33cccc; }
		body.retro-aol #video { background:#000; }
		body.retro-aol .summary { color:#e0e0e0; }
		body.retro-aol .chan-col { background:#355f5f; border-color:#33cccc; }
		body.retro-aol .grid-col { background:#3b6b6b; }
		body.retro-aol .chan-header,
		body.retro-aol .time-header-wrap { background:#004466; color:#ffcc00; border-color:#33cccc; }
		body.retro-aol .time-cell { color:#ffcc00; border-color:#1a3d3d; }
		body.retro-aol .chan-name { color:#ffffff; border-color:#33cccc; font-weight:bold; }
		body.retro-aol .program { background:#406d6d; border-color:#33cccc; color:#ffffff; }
		body.retro-aol .program.now { background:#33cccc; border-color:#004466; color:#000; font-weight:bold; }
		body.retro-aol .now-line { background:#ffcc00; }
		
		/* Retro MSN TV / WebTV Theme */
		body.retro-webtv { background:#dcdcdc; color:#001f3f; font-family:"Verdana","Arial",sans-serif; }
		body.retro-webtv .header { background:#4b0082; color:#ffffff; border-bottom:2px solid #003399; }
		body.retro-webtv #video { background:#000; }
		body.retro-webtv .summary { color:#222; }
		body.retro-webtv .chan-col { background:#e6e6e6; border-color:#4b0082; }
		body.retro-webtv .grid-col { background:#f5f5f5; }
		body.retro-webtv .chan-header,
		body.retro-webtv .time-header-wrap { background:#4b0082; color:#fff; border-color:#003399; }
		body.retro-webtv .time-cell { color:#001f3f; border-color:#999; }
		body.retro-webtv .chan-name { color:#001f3f; border-color:#4b0082; font-weight:bold; }
		body.retro-webtv .program { background:#ffffff; border-color:#4b0082; color:#001f3f; }
		body.retro-webtv .program.now { background:#003399; border-color:#001f3f; color:#fff; font-weight:bold; }
		body.retro-webtv .now-line { background:#00f; } /* bright blue NOW line */
		
		/* Retro TV Guide Channel (2000) Theme */
		body.retro-tvguide2000 { background:#002b80; color:#ffffff; font-family:"Verdana","Arial Black",sans-serif; }
		body.retro-tvguide2000 .header { background:#001a4d; color:#ffffff; border-bottom:2px solid #003399; }
		body.retro-tvguide2000 #video { background:#000; }
		body.retro-tvguide2000 .summary { color:#fff; }
		body.retro-tvguide2000 .chan-col { background:#cc0000; border-color:#990000; color:#fff; font-weight:bold; }
		body.retro-tvguide2000 .grid-col { background:#1a3faa; }
		body.retro-tvguide2000 .chan-header,
		body.retro-tvguide2000 .time-header-wrap { background:#001a4d; color:#ffffff; border-color:#0044cc; }
		body.retro-tvguide2000 .time-cell { color:#ffffff; border-color:#0044cc; }
		body.retro-tvguide2000 .chan-name { color:#ffffff; border-color:#003399; font-weight:bold; }
		body.retro-tvguide2000 .program { background:#1a3faa; border:1px solid #ffffff; color:#ffffff; }
		body.retro-tvguide2000 .program.now { background:#009933; border:1px solid #ffffff; color:#000; font-weight:bold; }
		body.retro-tvguide2000 .now-line { background:#ffff00; } /* yellow line */
		
		/* Retro TV Guide Magazine Theme */
		body.retro-magazine { background:#ffffff; color:#000000; font-family:"Times New Roman","Georgia",serif; }
		body.retro-magazine .header { background:#ffffff; color:#000; border-bottom:2px solid #000; font-weight:bold; }
		body.retro-magazine .header .links > a,
		body.retro-magazine .header .links > .dropdown > .dropbtn,
		body.retro-magazine .header .links > span,
		body.retro-magazine .header .links > #clock { background:#ffffff !important; color:#000000 !important; }
		body.retro-magazine .header .links > a:hover,
		body.retro-magazine .header .links > .dropdown:hover > .dropbtn { background:#e0e0e0 !important; color:#000000 !important; }
		body.retro-magazine .dropdown-content { background:#ffffff !important; color:#000000 !important; border:1px solid #000 !important; box-shadow:none !important; }
		body.retro-magazine .dropdown-content a { background:#ffffff !important; color:#000000 !important; }
		body.retro-magazine .dropdown-content a:hover { background:#e0e0e0 !important; color:#000000 !important; }
		body.retro-magazine #video { background:#000; }
		body.retro-magazine .summary { color:#000; }
		body.retro-magazine .chan-col { background:#fff; border:1px solid #000; color:#000; font-weight:bold; }
		body.retro-magazine .grid-col { background:#fff; }
		body.retro-magazine .chan-header,
		body.retro-magazine .time-header-wrap { background:#fff; color:#000; border:1px solid #000; font-weight:bold; }
		body.retro-magazine .time-cell { color:#000; border:1px solid #000; font-weight:bold; }
		body.retro-magazine .chan-name { color:#000; border:1px solid #000; font-weight:bold; }
		body.retro-magazine .program { background:#fff; border:1px solid #000; color:#000; font-size:14px; }
		body.retro-magazine .program.now { background:#e0e0e0; border:2px solid #000; color:#000; font-weight:bold; }
		body.retro-magazine .now-line { background:#000; height:3px; }
		body.retro-magazine #current-tuner { color:#000000 !important; font-weight:bold; }

		
    </style>
</head>
<body>
<div class="header">
    <!-- Left: menu block -->
    <div class="links">
        <span style="margin-right:20px; font-weight:bold;">Active Tuner: {{ current_tuner }}</span>
        <a href="{{ url_for('guide') }}">HOME</a>

        {% if current_user is defined and current_user.username == 'admin' %}
        <div class="dropdown">
            <button class="dropbtn">USER ADMIN ▾</button>
            <div class="dropdown-content">
                <a href="{{ url_for('add_user_route') }}">New User</a>
                <a href="{{ url_for('delete_user') }}">Delete User</a>
            </div>
        </div>
        {% endif %}

        <div class="dropdown">
            <button class="dropbtn">SETTINGS ▾</button>
            <div class="dropdown-content">
                {% if current_user is defined and current_user.username == 'admin' %}
                <a href="{{ url_for('change_tuner') }}">Change Tuner</a>
                <a href="{{ url_for('view_logs') }}">Logs</a>
                <li><a href="{{ url_for('about') }}">About</a></li>
                {% endif %}
                <a href="{{ url_for('change_password') }}">Change Password</a>
				<li class="submenu">
				  <a href="#">Themes</a>
				  <ul class="submenu-content">
				    <li><a href="#" onclick="setTheme('light'); return false;">Light</a></li>
				    <li><a href="#" onclick="setTheme('dark'); return false;">Dark</a></li>
					<li><a href="#" onclick="setTheme('retro-aol'); return false;">AOL / CompuServe</a></li>
				    <!-- ><li><a href="#" onclick="setTheme('retro-tvguide'); return false;">Retro TV Guide</a></li>
					<li><a href="#" onclick="setTheme('retro-webtv'); return false;">MSN TV / WebTV</a></li>
					<li><a href="#" onclick="setTheme('retro-tvguide2000'); return false;">TV Guide Channel (2000)</a></li> -->
					<li><a href="#" onclick="setTheme('retro-magazine'); return false;">TV Guide Magazine</a></li>
				  </ul>
				</li>
            </div>
        </div>

        <a href="{{ url_for('logout') }}">LOGOUT</a>
    </div>

    <!-- Right: live clock -->
    <div id="clock" class="clock">--:-- --</div>
</div>

<!-- Player row: summary left, video right -->
<div class="player">
    <div class="summary" id="summary">
        <h3>Program Info</h3>
        <p>Click a channel on the left to start playback.</p>
    </div>
    <video id="video" controls></video>
</div>

<!-- Guide grid -->
<div class="guide-outer">
    <div class="guide-row">
        <div class="chan-col"><div class="chan-header"></div></div>
        <div class="grid-col">
            <div class="time-header-wrap">
                <div class="grid-content">
                    <div class="time-header">
                        {% for t in hours_header %}
                            <div class="time-cell" data-utc="{{ t.isoformat() }}">{{ t.isoformat() }}</div>
                        {% endfor %}
                    </div>
                    <div class="now-line" id="nowLine"></div>
                </div>
            </div>
        </div>
    </div>

    {% for ch in channels %}
    <div class="guide-row" data-cid="{{ ch.tvg_id }}">
        <div class="chan-col">
            <div class="chan-name"
                 data-url="{{ ch.url }}"
                 data-cid="{{ ch.tvg_id }}"
                 data-name="{{ ch.name|e }}">
                {% if ch.logo %}<img src="{{ ch.logo }}" alt="">{% endif %}
                <span>{{ ch.name }}</span>
            </div>
        </div>
        <div class="grid-col">
            <div class="grid-content">
                {% set cid = ch.tvg_id %}
                {% for prog in epg.get(cid, []) %}
                    {% if prog.start and prog.stop %}
                        {% set left = ((prog.start - grid_start).total_seconds()/60) * SCALE %}
                        {% set calc_width = (prog.stop - prog.start).total_seconds()/60 * SCALE %}
                        {% set width = 24 if calc_width < 24 else calc_width %}
                        <div class="program {% if prog.start <= now <= prog.stop %}now{% endif %}"
                             style="left:{{ left }}px; width:{{ width }}px;"
                             data-start="{{ prog.start.isoformat() }}"
                             data-stop="{{ prog.stop.isoformat() }}"
                             data-title="{{ prog.title }}"
                             data-desc="{{ prog.desc }}">
                            {{ prog.title }}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script src="{{ url_for('static', filename='hls.js') }}"></script>
<script>
let hlsInstance = null;
let currentChannelId = null;

function playChannel(url, cid, name) {
    const video = document.getElementById('video');
    currentChannelId = cid;
    updateSummary(cid, name);

    // 🔥 Log playback to backend
    fetch("/play_channel", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "channel_name=" + encodeURIComponent(name)
    });

    if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
    if (Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
    } else {
        video.src = url;
        video.play().catch(()=>{});
    }
}

function updateSummary(cid, fallbackName) {
    const summary = document.getElementById('summary');
    const now = new Date();
    const row = document.querySelector(`.guide-row[data-cid="${cid}"]`);
    if (!row) return;

    let currentProg = null;
    row.querySelectorAll('.program').forEach(prog => {
        const start = new Date(prog.dataset.start);
        const stop = new Date(prog.dataset.stop);
        if (start <= now && stop >= now) currentProg = prog;
    });

    if (currentProg) {
        const title = currentProg.dataset.title || fallbackName;
        const desc = currentProg.dataset.desc || '';
        const start = new Date(currentProg.dataset.start);
        const stop = new Date(currentProg.dataset.stop);
        summary.innerHTML = `<h3>${title}</h3>
                             <p>${desc}</p>
                             <p>${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${stop.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</p>`;
    } else {
        summary.innerHTML = `<h3>${fallbackName}</h3><p>No Program Info</p>`;
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.body.classList.add(savedTheme);

    document.querySelectorAll('.chan-name').forEach(el => {
        el.addEventListener('click', () => {
            playChannel(el.dataset.url, el.dataset.cid, el.dataset.name);
        });
    });

    document.querySelectorAll('.time-cell').forEach(cell => {
        const utc = new Date(cell.dataset.utc);
        cell.textContent = utc.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    });

    document.querySelectorAll('.program').forEach(prog => {
        const start = new Date(prog.dataset.start);
        const stop = new Date(prog.dataset.stop);
        prog.title = `${prog.dataset.title}\n${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${stop.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
    });

    updateClock();
    setInterval(updateClock, 1000);
    updateNowLine();
    setInterval(updateNowLine, 60000);
});

function setTheme(theme) {
    const body = document.body;
    // Remove all possible theme classes
    body.classList.remove("light", "dark", "retro-tvguide", "retro-aol", "retro-webtv", "retro-tvguide2000", "retro-magazine");
    // Add the new one
    body.classList.add(theme);
    // Save it for next load
    localStorage.setItem("theme", theme);
}

// On load, apply saved theme or default
document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem("theme") || "dark";
    setTheme(savedTheme);
});

function updateClock() {
    const now = new Date();
    const el = document.getElementById('clock');
    if (el) {
        el.textContent = now.toLocaleString([], {
            weekday:'short', month:'short', day:'numeric',
            hour:'2-digit', minute:'2-digit', second:'2-digit'
        });
    }
}

function updateNowLine() {
    const gridStart = new Date("{{ grid_start.isoformat() }}");
    const scale = {{ SCALE }};
    const now = new Date();
    const minutesFromStart = (now - gridStart) / 60000;
    const nl = document.getElementById('nowLine');
    if (nl) nl.style.left = (minutesFromStart * scale) + "px";
}
</script>
</body>
</html>

