<!doctype html>
<html>
<head>
    <title>Live TV Guide</title>
    <style>
        /* Make the page itself non-scrollable so only the guide area scrolls */
        html, body { height: 100%; overflow: hidden; }

        /* Header + menus */
        body { font-family: Arial, sans-serif; margin:0; }
        .header { background:#222; height:40px; display:flex; justify-content:space-between; align-items:center; padding:0 10px; }
        .header .links { display:flex; align-items:center; height:100%; gap:10px; }
        .header .links > a, .header .links > .dropdown > .dropbtn, .header .links > span, .header .links > div#clock {
            display:flex; align-items:center; justify-content:center; padding:0 12px;
            color:#eee; font-weight:bold; text-decoration:none; height:40px; line-height:40px;
        }
        .header .links > a:hover, .header .links > .dropdown:hover > .dropbtn { background:#111; color:#0af; }
        .dropdown { position:relative; }
        .dropbtn { background:none; border:none; font:inherit; color:inherit; cursor:pointer; }
        .dropdown-content {
            display:none; position:absolute; top:100%; left:0; background:#333; min-width:180px;
            border-radius:3px; box-shadow:0 4px 6px rgba(0,0,0,0.3);
        }
        .dropdown-content a { padding:10px 14px; display:block; color:#eee; text-decoration:none; }
        .dropdown-content a:hover { background:#0af; color:#fff; }
        .dropdown:hover .dropdown-content { display:block; }

        /* Submenu (fly-out for Themes) */
        .submenu {
            position: relative;
        }
        .submenu > a {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .submenu-content {
            display: none;
            position: absolute;
            top: 0;
            left: 100%; /* fly out to the right */
            background-color: #333;
            min-width: 160px;
            border-radius: 3px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .submenu-content li a {
            padding: 10px 14px;
            display: block;
            color: #eee;
            text-decoration: none;
        }
        .submenu-content li a:hover {
            background-color: #0af;
            color: #fff;
        }
        .submenu:hover .submenu-content {
            display: block;
        }

		/* Remove default list bullets and padding for all dropdowns & submenus */
		.dropdown-content,
		.submenu ul,
		.submenu-content {
		    list-style: none;
		    margin: 0;
		    padding: 0;
		}

        /* Player row: Program Info (left) | Video (right) */
        .player { display:flex; gap:16px; padding:12px; }
        .summary { flex:1; }
        #video  { width:620px; height:350px; }

        /* Guide grid */
        .guide-outer { 
            height: calc(100vh - 420px); 
            overflow-y: auto; 
            padding-bottom: 80px;
            position: relative;
        }
        .guide-row { display:flex; }
        .chan-col  { width: 200px; flex-shrink:0; border-right:1px solid; position: relative; z-index: 2; background: var(--chan-col-bg, #1a1a1a); }
        .grid-col  { position:relative; flex:1; overflow-x:auto; overflow-y:visible; z-index:1; }
        .chan-header { height: 34px; border-bottom:1px solid; position:sticky; top:0; z-index:5; }
        .time-header-wrap { position:sticky; top:0; z-index:6; border-bottom:1px solid; }

        .time-cell { flex:0 0 {{ 30*SCALE }}px; width:{{ 30*SCALE }}px; text-align:center; border-right:1px solid; font-weight:600; }
        .chan-name { 
	    padding: 10px; height: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
	    gap: 6px; border-bottom: 1px solid;  cursor: pointer; position: relative;  z-index: 10; pointer-events: auto; user-select: none;
        }
        .chan-name img { width:36px; height:36px; object-fit:contain; margin-bottom: 4px; }
        .grid-row  { position:relative; height:60px; border-bottom:1px solid; }
        .grid-content { position:relative; width: {{ total_width }}px; min-height:100%; }
        .program { position:absolute; top:6px; height:48px; border:1px solid; padding:4px 6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
                   font-size:12px; border-radius:6px; z-index:1; } /* ensure fixed header sits above programs */
        .program.now { font-weight:bold; }
        .now-line { position:absolute; top:0; bottom:0; width:2px; z-index:8; pointer-events:none; left: {{ now_offset }}px; }

        /* Fixed time header (new) */
        .time-header-fixed {
            position: fixed;
            z-index: 1200; /* high so it always sits on top */
            left: 0; /* now covers entire viewport width; we add a left spacer to keep times aligned */
            display: flex;
            align-items: stretch;
            overflow: hidden;
            background: transparent; /* spacer will paint the left channel background */
            box-shadow: 0 2px 6px rgba(0,0,0,0.12);
            height: 34px;
            top: 0; /* set by JS */
        }
        .time-header-fixed .grid-content { display:flex; align-items:stretch; position:relative; height:100%; width:100%; }
        .time-header-fixed .time-header { display:flex; align-items:center; height:100%; flex: 0 0 auto; }
        .time-header-fixed .time-cell { display:inline-flex; align-items:center; justify-content:center; height:100%; border-right:1px solid var(--timebar-border, #ccc); padding:0 6px; font-weight:600; background: var(--timebar-bg, rgba(255,255,255,0.95)); color:var(--timebar-color,#000); }
        .time-header-fixed .now-line { position:absolute; top:0; bottom:0; width:2px; z-index:1300; pointer-events:none; }

        .time-header-fixed .left-spacer {
            flex: 0 0 auto;
            height:100%;
            background: var(--chan-col-bg, #1a1a1a);
            border-right: 1px solid var(--timebar-border, rgba(0,0,0,0.12));
        }

        /* Keep original in-grid time header hidden when using fixed header */
        .hide-in-grid .time-header-wrap { visibility: hidden; height: 0; margin:0; padding:0; }

        /* Theme-specific timebar and channel background variables (so fixed bar and the left spacer match theme) */

        /* Dark theme */
        body.dark { --timebar-bg:#222; --timebar-border:#444; --timebar-color:#ddd; --chan-col-bg:#1a1a1a; background:#111; color:#ddd; }
        body.dark .time-header-fixed .now-line { background:#0f0; }
        body.dark {--timebar-bg: #222; --timebar-border: #444; --timebar-color: #ddd; --now-line-color: #0f0; --chan-col-bg: #1a1a1a; }
        body.dark { background:#111; color:#ddd; }
        body.dark .header { background:#222; }
        body.dark #video { background:#000; }
        body.dark .summary { color:#ccc; }
        body.dark .chan-col { background:#1a1a1a; border-color:#333; }
        body.dark .grid-col { background:#181818; }
        body.dark .chan-header, body.dark .time-header-wrap { background:#222; border-color:#444; }
        body.dark .time-cell { color:#bbb; border-color:#333; }
        body.dark .chan-name { color:#fff; border-color:#333; }
        body.dark .program { background:#3a3a3a; border-color:#555; color:#eee; }
        body.dark .program.now { background:#2d5030; border-color:#47a447; }
        body.dark .now-line { background:#0f0; }
        
        /* Light theme */
        body.light { --timebar-bg:#fff; --timebar-border:#ddd; --timebar-color:#000; --chan-col-bg:#f9f9f9; background:#fff; color:#000; }
        body.light .time-header-fixed .now-line { background:#090; }
        body.light { --timebar-bg: #fff; --timebar-border: #ddd; --timebar-color: #000; --now-line-color: #090; --chan-col-bg: #f9f9f9; }
        body.light { background:#fff; color:#000; }
        body.light .header { background:#222; }
        body.light #video { background:#fff; }
        body.light .summary { color:#000; }
        body.light .chan-col { background:#f9f9f9; border-color:#ccc; }
        body.light .grid-col { background:#fafafa; }
        body.light .chan-header, body.light .time-header-wrap { background:#ddd; border-color:#bbb; }
        body.light .time-cell { color:#000; border-color:#ccc; }
        body.light .chan-name { color:#000; border-color:#ccc; }
        body.light .program { background:#ddd; border-color:#aaa; color:#000; }
        body.light .program.now { background:#cfe8cf; border-color:#090; }
        body.light .now-line { background:#090; }

	      /* Retro AOL / CompuServe Theme */
	      body.retro-aol { --timebar-bg:#2f4f4f; --timebar-border:#33cccc; --timebar-color:#000; --chan-col-bg:#2f4f4f; }
        body.retro-aol .time-header-fixed .now-line { background:#090; }
        body.retro-aol { --timebar-bg: #2f4f4f; --timebar-border: #33cccc; --timebar-color: #000; --now-line-color: #090; --chan-col-bg: #2f4f4f; }
	      body.retro-aol { background:#2f4f4f; color:#f0f0f0; font-family:"Tahoma","Arial",sans-serif; }
	      body.retro-aol .header { background:#004466; color:#ffcc00; border-bottom:2px solid #33cccc; }
	      body.retro-aol #video { background:#000; }
	      body.retro-aol .summary { color:#e0e0e0; }
	      body.retro-aol .chan-col { background:#355f5f; border-color:#33cccc; }
	      body.retro-aol .grid-col { background:#3b6b6b; }
	      body.retro-aol .chan-header,
	      body.retro-aol .time-header-wrap { background:#004466; color:#ffcc00; border-color:#33cccc; }
	      body.retro-aol .time-cell { color:#ffcc00; border-color:#1a3d3d; }
	      body.retro-aol .chan-name { color:#ffffff; border-color:#33cccc; font-weight:bold; }
	      body.retro-aol .program { background:#406d6d; border-color:#33cccc; color:#ffffff; }
	      body.retro-aol .program.now { background:#33cccc; border-color:#004466; color:#000; font-weight:bold; }
	      body.retro-aol .now-line { background:#ffcc00; }

        /* === RetroIPTVGuide Theme: TV Guide 1990 Edition (Final Compact) === */
        body.tvguide1990 { --timebar-bg: #fff; --timebar-border: #000; --timebar-color: #000; --chan-col-bg: #d8d7d3; }
        body.tvguide1990 .time-header-fixed { box-shadow:none; }
        body.tvguide1990 .time-header-fixed .now-line { background:#000; height:3px; }
        body.tvguide1990 { --timebar-bg: #fff; --timebar-border: #000; --timebar-color: #000; --now-line-color: #000; --chan-col-bg: #d8d7d3; }
	      body.tvguide1990{background:#d8d7d3;color:#000;font-family:'Times New Roman',serif;font-size:.9em;}
	      body.tvguide1990 .header{background:#fff;color:#000;border-bottom:2px solid #000;box-shadow:none;}
	      body.tvguide1990 .header .links>a,
	      body.tvguide1990 .header .links>.dropdown>.dropbtn,
	      body.tvguide1990 .header .links>span,
	      body.tvguide1990 .header .links>#clock{color:#000!important;background:#fff!important;}
	      body.tvguide1990 .header .links>a:hover,
	      body.tvguide1990 .header .links>.dropdown:hover>.dropbtn{background:#e0e0e0!important;color:#000!important;}
	      body.tvguide1990 .dropdown-content{background:#fff!important;color:#000!important;border:1px solid #000!important;box-shadow:none!important;}
	      body.tvguide1990 .dropdown-content a{color:#000!important;}
	      body.tvguide1990 .dropdown-content a:hover{background:#e0e0e0!important;color:#000!important;}
	      body.tvguide1990 .submenu-content{background:#fff!important;border:1px solid #000!important;box-shadow:none!important;z-index:1000;}
	      body.tvguide1990 .submenu-content li a{color:#000!important;}
	      body.tvguide1990 .submenu-content li a:hover{background:#e0e0e0!important;color:#000!important;}
	      body.tvguide1990 .dropdown-content .submenu>a{color:#000!important;padding-right:22px!important;position:relative;}
	      body.tvguide1990 .dropdown-content .submenu>a::after{content:"â–¸";position:absolute;right:10px;top:50%;transform:translateY(-50%);color:#000;}
	      body.tvguide1990 .dropdown-content .submenu:hover>a{background:#e0e0e0!important;color:#000!important;}
	      body.tvguide1990 .footer{background:transparent;color:#000;border-top:2px solid #000;}
	      body.tvguide1990 .chan-name img{display:none!important;}
	      body.tvguide1990 .chan-name span:not(.channel-number){display:none!important;}
	      body.tvguide1990 .chan-col{height:38px!important;padding:2px 0!important;display:flex;align-items:center;justify-content:center;background:#d8d7d3;border-bottom:1px solid #000;}
	      body.tvguide1990 .guide-row>.chan-col{border-right:1px solid #000!important;} /* vertical divider */
	      body.tvguide1990 .channel-number{display:inline-flex;align-items:center;justify-content:center;font-family:'Arial Narrow','Helvetica Neue',sans-serif;font-weight:700;font-size:.9em;min-width:32px;padding:3px 12px;border-radius:999px;background:#000;color:#fff;letter-spacing:-.2px;border:1px solid #000;line-height:1;transform:scale(.9);}
	      body.tvguide1990 .chan-header{border-bottom:none!important;}
	      body.tvguide1990 .guide-row{align-items:stretch!important;}
	      body.tvguide1990 .time-header-wrap{border-top:1px solid #000!important;border-bottom:1px solid #000!important;margin-bottom:0!important;padding-bottom:0!important;height:38px!important;box-sizing:border-box;}
	      body.tvguide1990 .chan-col{height:38px!important;box-sizing:border-box;}
	      body.tvguide1990 .grid-content,body.tvguide1990 .time-header{transform:scaleX(.9);transform-origin:left center;}
	      body.tvguide1990 .time-cell{border-right:1px solid #000;color:#000;font-weight:700;font-size:.8em;padding:0 2px;min-width:0;}
	      body.tvguide1990 .grid-row{height:38px!important;position:relative;padding:1px 0;box-sizing:border-box;border-bottom:1px solid #000;}
	      body.tvguide1990 .program,
	      body.tvguide1990 .program.now{position:absolute;top:1px!important;height:calc(100% - 2px)!important;margin:0!important;padding:2px 4px!important;border:1px solid #000;box-sizing:border-box;border-radius:0!important;line-height:1.2;font-size:.8em!important;display:flex;align-items:center;background:#fff;font-weight:400!important;}
	      body.tvguide1990 .program.now{background:#e7e5dd!important;font-weight:700!important;}
	      body.tvguide1990 .grid-col{overflow-x:auto!important;overflow-y:hidden!important;height:38px!important;box-sizing:border-box;}
	      body.tvguide1990 .grid-content{height:100%!important;}
	      body.tvguide1990 #clock::before{content:"IPTV GUIDE";display:inline-block;margin-right:10px;padding:4px 10px;background:#fff;color:#000;font-weight:900;font-size:12px;line-height:1;border-radius:50px;border:2px solid #000;box-shadow:none;letter-spacing:.3px;vertical-align:middle;}
	      body.tvguide1990 #summary{border:2px solid #000;background:#fff;padding:12px;margin:10px;box-shadow:2px 2px 5px rgba(0,0,0,.25);}
	      body.tvguide1990 #video{border:2px solid #000;background:#000;box-shadow:3px 3px 6px rgba(0,0,0,.35);}
	      body.tvguide1990 .chan-col{position:relative;}
	      body.tvguide1990 .chan-col::before{content:"";position:absolute;left:0;top:50%;transform:translateY(-50%);width:20px;height:60%;background:#000;border-right:1px solid #000;}


        /* DirecTV */
        body.directv { --timebar-bg:#002b80; --timebar-border:#001f66; --timebar-color:#d8ebff; --chan-col-bg:#001b50; }
        body.directv .time-header-fixed .now-line { background:#ffcc00; }
        body.directv { --timebar-bg: #002b80; --timebar-border: #001f66; --timebar-color: #d8ebff; --now-line-color: #ffcc00; --chan-col-bg: #001b50; }
	      body.directv { background:#001a66; color:#fff; font-family:"Segoe UI","Arial",sans-serif; }
	      body.directv .header { background:linear-gradient(to bottom,#1d72ff,#003a8c); border-bottom:2px solid #001f66; }
	      body.directv .header .links > a, body.directv .header .links > .dropdown > .dropbtn, body.directv .header .links > span, body.directv .header .links > div#clock { color:#ffffff !important; font-weight:bold !important; text-shadow:1px 1px 2px #000 !important; }
	      body.directv .header .links > a:hover, body.directv .header .links > .dropdown:hover > .dropbtn { background:#003f9e !important; color:#ffd802 !important; }
	      body.directv .dropdown-content, body.directv .submenu-content { background:#003a8c !important; border:1px solid #0070ff !important; box-shadow:0 4px 8px rgba(0,0,0,.4) !important; }
	      body.directv .dropdown-content a, body.directv .submenu-content li a { color:#ffffff !important; font-weight:bold !important; }
	      body.directv .dropdown-content a:hover, body.directv .submenu-content li a:hover { background:#0070ff !important; color:#fff !important; }
	      body.directv .dropdown-content .submenu > a { color:#fff !important; padding-right:28px !important; position:relative; }
	      body.directv .dropdown-content .submenu > a::after { content:"â–¸"; position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#fff; }
	      body.directv .dropdown-content .submenu:hover > a { background:#0070ff !important; color:#fff !important; }
	      body.directv .summary, body.directv #program-info { background:linear-gradient(to bottom,#66b2ff,#003f9e); color:#fff; border:1px solid #004bdb; }
	      body.directv .time-header-wrap { background:#002b80; color:#d8ebff; border-bottom:2px solid #001f66; }
	      body.directv .time-cell { background:#002b80; color:#b9dcff; border-color:#001f66; font-weight:bold; }
	      body.directv .chan-col { background:#001f66; border-right:1px solid #004bdb; color:#fff; font-weight:bold; text-shadow:1px 1px 2px #000; }
	      body.directv .chan-header { background:linear-gradient(to bottom,#0b3b8c,#3c8dff); color:#fff; border-color:#003b91; }
	      body.directv .grid-col { background:#001f66; }
	      body.directv .program { background:#003a8c; border:1px solid #004bdb; color:#fff; border-radius:2px; }
	      body.directv .program.now { background:#ffd802; border:1px solid #caa600; color:#000; font-weight:bold; box-shadow:none; }
	      body.directv .program:hover { background:linear-gradient(to right,#1d67d9,#7fbfff); color:#fff; }
	      body.directv .now-line { background:#ffcc00; }
	      body.directv .footer { background:linear-gradient(to top,#001f66,#004bdb); color:#fff; border-top:2px solid #003580; padding:5px 10px; font-size:0.9em; }
	      body.directv .footer .dot-red { color:#ff3c3c; } body.directv .footer .dot-green { color:#00cc00; } body.directv .footer .dot-yellow { color:#ffd700; } body.directv .footer .dot-blue { color:#4ca9ff; }
	      body.directv #video { background:#000; border:2px solid #004bdb; box-shadow:0 0 6px rgba(0,0,0,0.6); }
	      body.directv #clock::before { content:"IPTV GUIDE"; display:inline-block; margin-right:10px; padding:3px 8px; background:#e41e26; color:#fff; font-weight:900; font-size:12px; line-height:1; border-radius:3px; border:1px solid rgba(255,255,255,.85); box-shadow:0 1px 2px rgba(0,0,0,.35); letter-spacing:.4px; vertical-align:middle; }

        /* Comcast */
        body.comcast { --timebar-bg:linear-gradient(to bottom,#0055cc,#001b50); --timebar-border:#003090; --timebar-color:#fff; --chan-col-bg:#001b50; }
        body.comcast .time-header-fixed .now-line { background:#ffcc00; }
        body.comcast { --timebar-bg: linear-gradient(to bottom,#0055cc,#001b50); --timebar-border: #003090; --timebar-color: #fff; --now-line-color: #ffcc00; --chan-col-bg: #001b50; }
        body.comcast { background:#001b50; color:#fff; font-family:"Segoe UI","Arial",sans-serif; }
	      body.comcast .header { background:linear-gradient(to bottom,#0055cc,#001b50); border-bottom:2px solid #003090; }
	      body.comcast .header .links > a, body.comcast .header .links > .dropdown > .dropbtn, body.comcast .header .links > span, body.comcast .header .links > div#clock { color:#ffffff !important; font-weight:bold !important; text-shadow:1px 1px 2px #000 !important; }
	      body.comcast .header .links > a:hover, body.comcast .header .links > .dropdown:hover > .dropbtn { background:#003890 !important; color:#ffcc00 !important; }
	      body.comcast .dropdown-content, body.comcast .submenu-content { background:#002a70 !important; border:1px solid #0044cc !important; box-shadow:0 4px 8px rgba(0,0,0,.4) !important; }
	      body.comcast .dropdown-content a, body.comcast .submenu-content li a { color:#ffffff !important; font-weight:bold !important; }
	      body.comcast .dropdown-content a:hover, body.comcast .submenu-content li a:hover { background:#0044cc !important; color:#fff !important; }
	      body.comcast .summary, body.comcast #program-info { background:linear-gradient(to bottom,#001b50,#003890); color:#fff; border:1px solid #003090; }
	      body.comcast .time-header-wrap { background:#003890; color:#bcd8ff; border-bottom:2px solid #002b80; }
	      body.comcast .time-cell { background:#003890; color:#ffffff; border-color:#002b80; font-weight:bold; }
	      body.comcast .chan-col { background:#001b50; border-right:1px solid #0044cc; color:#fff; font-weight:bold; text-shadow:1px 1px 2px #000; }
	      body.comcast .chan-header { background:#002a70; color:#fff; border-color:#0044cc; }
	      body.comcast .grid-col { background:#002a70; }
	      body.comcast .program { background:#003890; border:1px solid #0044cc; color:#fff; border-radius:2px; }
	      body.comcast .program.now { background:#ffffff; border:1px solid #cccccc; color:#000; font-weight:bold; }
	      body.comcast .program:hover { background:#0044cc; color:#fff; }
	      body.comcast .now-line { background:#ffcc00; }
	      body.comcast #video { background:#000; border:2px solid #0044cc; box-shadow:0 0 8px rgba(0,0,0,.6); }
	      body.comcast .footer { background:linear-gradient(to top,#001b50,#0044cc); color:#fff; border-top:2px solid #002b80; padding:5px 10px; font-size:0.9em; }
	      body.comcast .footer .dot-red { color:#ff3c3c; } body.comcast .footer .dot-green { color:#00cc00; } body.comcast .footer .dot-yellow { color:#ffd700; }      body.comcast .footer .dot-blue { color:#4ca9ff; }
	      body.comcast #clock::before { content:"IPTV GUIDE"; display:inline-block; margin-right:10px; padding:3px 8px; background:#e41e26; color:#fff; font-weight:900; font-size:12px; line-height:1; border-radius:3px; border:1px solid rgba(255,255,255,.85); box-shadow:0 1px 2px rgba(0,0,0,.35); letter-spacing:.4px; vertical-align:middle; }
	
	    /* Retro TV Guide Magazine Theme */
	    body.retro-magazine { background:#ffffff; color:#000000; font-family:"Times New Roman","Georgia",serif; }
	    body.retro-magazine .header { background:#ffffff; color:#000; border-bottom:2px solid #000; font-weight:bold; }
	    body.retro-magazine .header .links > a,
	    body.retro-magazine .header .links > .dropdown > .dropbtn,
	    body.retro-magazine .header .links > span,
	    body.retro-magazine .header .links > #clock { background:#ffffff !important; color:#000000 !important; }
	    body.retro-magazine .header .links > a:hover,
	    body.retro-magazine .header .links > .dropdown:hover > .dropbtn { background:#e0e0e0 !important; color:#000000 !important; }
	    body.retro-magazine .dropdown-content { background:#ffffff !important; color:#000000 !important; border:1px solid #000 !important; box-shadow:none !important; }
	    body.retro-magazine .dropdown-content a { background:#ffffff !important; color:#000000 !important; }
	    body.retro-magazine .dropdown-content a:hover { background:#e0e0e0 !important; color:#000000 !important; }
	    body.retro-magazine #video { background:#000; }
	    body.retro-magazine .summary { color:#000; }
	    body.retro-magazine .chan-col { background:#fff; border:1px solid #000; color:#000; font-weight:bold; }
	    body.retro-magazine .grid-col { background:#fff; }
	    body.retro-magazine .chan-header,
	    body.retro-magazine .time-header-wrap { background:#fff; color:#000; border:1px solid #000; font-weight:bold; }
	    body.retro-magazine .time-cell { color:#000; border:1px solid #000; font-weight:bold; }
	    body.retro-magazine .chan-name { color:#000; border:1px solid #000; font-weight:bold; }
	    body.retro-magazine .program { background:#fff; border:1px solid #000; color:#000; font-size:14px; }
	    body.retro-magazine .program.now { background:#e0e0e0; border:2px solid #000; color:#000; font-weight:bold; }
	    body.retro-magazine .now-line { background:#000; height:3px; }
	    body.retro-magazine #current-tuner { color:#000000 !important; font-weight:bold; }
	    
	/* Add other theme variables as needed */

	body{transition:background-color .3s ease,color .3s ease;}
	body.fade-switch{opacity:0;transition:opacity .25s ease;}

/* Insert inside <style> in head (update/append) */
.header {
  position: relative;   /* make z-index take effect */
  z-index: 2000;        /* must be higher than .time-header-fixed and .now-line */
}

/* Ensure dropdowns and submenu flyouts are above everything */
.dropdown-content,
.submenu-content {
  position: absolute;   /* should already be absolute, but ensure it */
  z-index: 2100;        /* higher than .header and the fixed time bar */
}

/* If you want submenu children to stack above parent dropdowns too */
.dropdown-content .submenu,
.submenu-content .submenu {
  z-index: 2200;
}

/* If you need to keep the time bar behind menus explicitly, ensure it's lower than header */
.time-header-fixed {
  z-index: 1200; /* keep this below header (2000) */
}

/* Keep the now-line under dropdowns */
.time-header-fixed .now-line {
  z-index: 1250; /* still above programs but below dropdowns/header */
}

/* --- Fixed timebar core (keep once globally) --- */
.time-header-fixed {
  position: fixed;
  top: 0; /* JS will adjust */
  left: 0;
  width: 100%;
  height: 34px;
  display: flex;
  align-items: stretch;
  z-index: 1200;               /* below header/dropdowns but above programs */
  background: var(--timebar-bg, #fff);      /* MUST be opaque for clipping to look correct */
  border-bottom: 1px solid var(--timebar-border, #ccc);
  box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  pointer-events: none;       /* allow clicks to drop through except for dropdowns which are higher z */
}

/* The left spacer (covers the channel column area visually) */
.time-header-fixed .left-spacer {
  flex: 0 0 auto;
  width: var(--chan-col-width, 200px); /* JS sets exact width */
  background: var(--chan-col-bg, #1a1a1a); /* themeable */
  border-right: 1px solid var(--timebar-border, #ccc);
  pointer-events: none;
}

/* The cloned time cells area (after the spacer) */
.time-header-fixed .time-header {
  display:flex;
  align-items:center;
  pointer-events: none;
  background: var(--timebar-bg, #fff);
  color: var(--timebar-color, #000);
}

/* Ensure the NOW line is above programs but under dropdown menus */
.time-header-fixed .now-line {
  position:absolute;
  top:0; bottom:0; width:2px;
  background: var(--now-line-color, #0f0);
  z-index: 1250; /* above .time-header-fixed content but below header/dropdowns which will have higher z */
  pointer-events: none;
}

/* Programs must be below the fixed timebar */
.program { z-index: 1; position: absolute; }

/* Header & dropdown must be above the timebar (keep these) */
.header { position: relative; z-index: 2000; }
.dropdown-content, .submenu-content { position: absolute; z-index: 2100; }
        /* Placeholder when no guide data exists */
        .program.no-guide { font-style: italic; color: #999; background: #2a2a2a; border: 1px dashed #555; }

    </style>
</head>
<body>
<div class="header">
    <div class="links">
        <span style="margin-right:20px; font-weight:bold;">Active Tuner: {{ current_tuner }}</span>
        <a href="{{ url_for('guide') }}">HOME</a>

        {% if current_user is defined and current_user.username == 'admin' %}
        <!-- âœ… Added next to USER ADMIN -->
		<a href="{{ url_for('manage_users') }}" id="manageUsersMenu">MANAGE USERS</a>
        {% endif %}

        <div class="dropdown" id="settingsMenu">
            <button class="dropbtn">SETTINGS â–¾</button>
            <div class="dropdown-content">
                {% if current_user is defined and current_user.username == 'admin' %}
                <a href="{{ url_for('change_tuner') }}">Change Tuner</a>
                <a href="{{ url_for('view_logs') }}">Logs</a>
                <li><a href="{{ url_for('about') }}">About</a></li>
                {% endif %}
                <a href="{{ url_for('change_password') }}">Change Password</a>
				<li class="submenu">
				  <a href="#">Themes</a>
				  <ul class="submenu-content">
				    <li><a href="#" onclick="setTheme('light'); return false;">Light</a></li>
				    <li><a href="#" onclick="setTheme('dark'); return false;">Dark</a></li>
					<li><a href="#" onclick="setTheme('retro-aol'); return false;">AOL / CompuServe</a></li>
					<li><a href="#" onclick="setTheme('retro-magazine'); return false;">TV Guide (Refresh)</a></li>
					<li><a href="#" onclick="setTheme('directv'); return false;">DirecTV</a></li>
					<li><a href="#" onclick="setTheme('comcast'); return false;">Comcast</a></li>
					<li><a href="#" onclick="setTheme('tvguide1990'); return false;">TV Guide (Classic)</a></li>
				  </ul>
				</li>
            </div>
        </div>

        <a href="{{ url_for('logout') }}">LOGOUT</a>
    </div>

    <div id="clock" class="clock">--:-- --</div>
</div>


<!-- Player row: summary left, video right -->
<div class="player" id="playerRow">
    <div class="summary" id="summary">
        <h3>Program Info</h3>
        <p>Click a channel on the left to start playback.</p>
    </div>
    <video id="video" controls playsinline preload="metadata" tabindex="0"></video>
</div>

<!-- FIXED time header (will be populated/positioned by JS) -->
<div id="fixedTimeBar" class="time-header-fixed" aria-hidden="false" role="presentation">
    <!-- content injected by JS -->
</div>

<!-- Guide grid -->
<div class="guide-outer" id="guideOuter">
    <!-- Keep original small time header inside grid for alignment, it will be hidden when fixed header is active -->
    <div class="guide-row hide-in-grid" id="gridTimeRow">
        <div class="chan-col"><div class="chan-header"></div></div>
        <div class="grid-col">
            <div class="time-header-wrap">
                <div class="grid-content">
                    <div class="time-header">
                        {% for t in hours_header %}
                            <div class="time-cell" data-utc="{{ t.isoformat() }}">{{ t.isoformat() }}</div>
                        {% endfor %}
                    </div>
                    <div class="now-line" id="nowLineOriginal" style="display:none;"></div>
                </div>
            </div>
        </div>
    </div>

    {% for ch in channels %}
    <div class="guide-row" data-cid="{{ ch.tvg_id }}">
        <div class="chan-col">
            <div class="chan-name"
                 data-url="{{ ch.url }}"
                 data-cid="{{ ch.tvg_id }}"
                 data-name="{{ ch.name|e }}"
		 data-logo="{{ ch.logo }}">
                {% if ch.logo %}<img src="{{ ch.logo }}" alt="">{% endif %}
                <span>{{ ch.name }}</span>
            </div>
        </div>
        <div class="grid-col">
            <div class="grid-content">
			{% set cid = ch.tvg_id %}
			{% set channel_epg = epg[cid] if cid in epg else [] %}
			{% if channel_epg|length == 0 %}
				<div class="program no-guide"
					style="left:0px; width:{{ 60 * SCALE }}px;">
					No Guide Data Available
				</div>
			{% else %}
				{% for prog in channel_epg %}
					{% if prog.title == 'No Guide Data Available' %}
						<div class="program no-guide"
							style="left:0px; width:{{ 60 * SCALE }}px;">
							{{ prog.title }}
						</div>
					{% elif prog.start and prog.stop %}
						{% set left = ((prog.start - grid_start).total_seconds()/60) * SCALE %}
						{% set calc_width = (prog.stop - prog.start).total_seconds()/60 * SCALE %}
						{% set width = 24 if calc_width < 24 else calc_width %}
						<div class="program {% if prog.start <= now <= prog.stop %}now{% endif %}"
							style="left:{{ left }}px; width:{{ width }}px;"
							data-start="{{ prog.start.isoformat() }}"
							data-stop="{{ prog.stop.isoformat() }}"
							data-title="{{ prog.title }}"
							data-desc="{{ prog.desc }}">
							{{ prog.title }}
						</div>
					{% endif %}
				{% endfor %}
			{% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script src="{{ url_for('static', filename='hls.js') }}"></script>
<script>
let hlsInstance = null;
let currentChannelId = null;

function playChannel(url, cid, name) {
    const video = document.getElementById('video');
    currentChannelId = cid;
    updateSummary(cid, name);

    // ðŸ”¥ Log playback to backend
    fetch("/play_channel", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "channel_name=" + encodeURIComponent(name)
    });

    if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
    if (Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
    } else {
        video.src = url;
        video.play().catch(()=>{});
    }
}

function updateSummary(cid, fallbackName) {
    const summary = document.getElementById('summary');
    const now = new Date();
    const row = document.querySelector(`.guide-row[data-cid="${cid}"]`);
    if (!row) return;

    let currentProg = null;
    row.querySelectorAll('.program').forEach(prog => {
        const start = new Date(prog.dataset.start);
        const stop = new Date(prog.dataset.stop);
        if (start <= now && stop >= now) currentProg = prog;
    });

    if (currentProg) {
        const title = currentProg.dataset.title || fallbackName;
        const desc = currentProg.dataset.desc || '';
        const start = new Date(currentProg.dataset.start);
        const stop = new Date(currentProg.dataset.stop);
        summary.innerHTML = `<h3>${title}</h3>
                             <p>${desc}</p>
                             <p>${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${stop.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</p>`;
    } else {
        summary.innerHTML = `<h3>${fallbackName}</h3><p>No Program Info</p>`;
    }
}

/* --- NEW: Fixed time header logic with left spacer ---
   The goal: the fixed bar visually extends across the left channel area (blank),
   while the actual time cells remain aligned with the program grid.
   Implementation: fixedBar covers full viewport width (left:0). Inside it we create
   a left spacer whose width == channel column width and paint that spacer with the
   channel column background (theme-aware via CSS variables). The cloned time-header
   is appended after the spacer so times start where they already do.
*/

function createOrUpdateFixedTimeBar(){
    const fixedBar = document.getElementById('fixedTimeBar');
    const gridTimeRow = document.getElementById('gridTimeRow');
    const guideOuter = document.getElementById('guideOuter');
    const playerRow = document.getElementById('playerRow');

    if (!gridTimeRow || !fixedBar || !guideOuter) return;

    // Clone the server-side time header cells
    const serverTimeHeader = gridTimeRow.querySelector('.time-header-wrap .grid-content .time-header');
    if (!serverTimeHeader) return;

    // clear existing
    fixedBar.innerHTML = '';

    // cloned container
    const clonedGridContent = document.createElement('div');
    clonedGridContent.className = 'grid-content';

    // left spacer so the times start where the grid content starts
    const spacer = document.createElement('div');
    spacer.className = 'left-spacer';

    // compute current channel column width
    const firstChanCol = document.querySelector('.guide-row .chan-col');
    const chanColWidth = firstChanCol ? Math.round(firstChanCol.getBoundingClientRect().width) : 200;
    spacer.style.width = chanColWidth + 'px';
    spacer.style.minWidth = chanColWidth + 'px';
    spacer.style.maxWidth = chanColWidth + 'px';

    // clone the time header and append after the spacer
    const clonedTimeHeader = serverTimeHeader.cloneNode(true);
    clonedTimeHeader.classList.add('time-header');
    clonedTimeHeader.style.display = 'flex';
    clonedTimeHeader.style.height = '100%';

    // append in order: spacer then header
    clonedGridContent.appendChild(spacer);
    clonedGridContent.appendChild(clonedTimeHeader);

    // create a now-line for the fixed header (positioned absolutely within clonedGridContent)
    const nowLine = document.createElement('div');
    nowLine.id = 'nowLineFixed';
    nowLine.className = 'now-line';
    nowLine.style.position = 'absolute';
    nowLine.style.top = '0';
    nowLine.style.bottom = '0';
    nowLine.style.width = '2px';
    nowLine.style.left = '0px';
    nowLine.style.pointerEvents = 'none';
    clonedGridContent.appendChild(nowLine);

    fixedBar.appendChild(clonedGridContent);

    // fixedBar spans whole viewport left->right (so the left spacer covers the channel area)
    fixedBar.style.left = '0px';
    fixedBar.style.width = window.innerWidth + 'px';

    // Position top: place it directly below the player row
    if (playerRow) {
        const rect = playerRow.getBoundingClientRect();
        fixedBar.style.top = rect.bottom + 'px';
    } else {
        const header = document.querySelector('.header');
        const headerRect = header ? header.getBoundingClientRect() : { bottom: 40 };
        fixedBar.style.top = headerRect.bottom + 'px';
    }

    // ensure the guide content is pushed down by the fixed bar height
    requestAnimationFrame(() => {
        const fbHeight = fixedBar.getBoundingClientRect().height || 34;
        const currentPaddingTop = parseFloat(window.getComputedStyle(guideOuter).paddingTop) || 0;
        if (currentPaddingTop < fbHeight) {
            guideOuter.style.paddingTop = fbHeight + 'px';
        }
    });

    // hide the original in-grid now-line (we use the fixed one)
    const origNow = document.getElementById('nowLineOriginal');
    if (origNow) origNow.style.display = 'none';
}

// update fixed now-line and also original now-line left (if original present)
function updateNowLine(){
    const gridStart = new Date("{{ grid_start.isoformat() }}");
    const scale = {{ SCALE }};
    const now = new Date();
    const minutesFromStart = (now - gridStart) / 60000;
    const leftPx = (minutesFromStart * scale);

    // compute channel column width again (ensure sync if responsive)
    const firstChanCol = document.querySelector('.guide-row .chan-col');
    const chanColWidth = firstChanCol ? firstChanCol.getBoundingClientRect().width : 0;

    // Fixed now-line: because we include the left spacer inside the fixed bar, add its width
    const nlFixed = document.getElementById('nowLineFixed');
    if (nlFixed) nlFixed.style.left = (leftPx + chanColWidth) + 'px';

    // In case original now-line is being used, update it too
    const nlOrig = document.getElementById('nowLineOriginal');
    if (nlOrig) nlOrig.style.left = leftPx + 'px';
}

document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.body.classList.add(savedTheme);

    document.querySelectorAll('.chan-name').forEach(el => {
        el.addEventListener('click', () => {
            playChannel(el.dataset.url, el.dataset.cid, el.dataset.name);
        });
    });

    document.querySelectorAll('.time-cell').forEach(cell => {
        const utc = new Date(cell.dataset.utc);
        cell.textContent = utc.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    });

    document.querySelectorAll('.program').forEach(prog => {
        const start = new Date(prog.dataset.start);
        const stop = new Date(prog.dataset.stop);
        prog.title = `${prog.dataset.title}\n${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${stop.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
    });

    // Create and position the fixed time bar immediately after DOM ready
    createOrUpdateFixedTimeBar();
    updateClock();
    updateNowLine();

    // Keep clock & now-line updated
    setInterval(updateClock, 1000);
    setInterval(updateNowLine, 60000);
});

// Recompute positions on resize (so fixed bar stays aligned)
window.addEventListener('resize', () => {
    createOrUpdateFixedTimeBar();
    updateNowLine();
});

/* --- Theme & UI helpers --- (unchanged) */
function setTheme(theme){
  const b=document.body;
  /* start fade out */
  b.classList.add("fade-switch");
  setTimeout(()=>{
    const wasTVG=b.classList.contains("tvguide1990");
    b.classList.remove("light","dark","retro-tvguide","retro-aol","retro-webtv",
                       "retro-tvguide2000","retro-magazine","directv","comcast","tvguide1990");
    b.classList.add(theme);
    localStorage.setItem("theme",theme);

    /* ðŸ§© Restore logos + names when leaving TV Guide 1990 */
    if(wasTVG && theme!=="tvguide1990"){
      document.querySelectorAll(".chan-col .chan-name").forEach(el=>{
        const name=el.dataset.name||"Channel";
        const logo=el.dataset.logo;
        el.innerHTML=logo?`<img src="${logo}" alt=""><span>${name}</span>`:`<span>${name}</span>`;
      });
      document.querySelectorAll(".grid-row,.chan-col").forEach(r=>r.style.height="");
    }

    /* ðŸŽ¨ Inject number capsules for TV Guide 1990 */
    if(theme==="tvguide1990") requestAnimationFrame(applyTvGuide1990Capsules);

    /* end fade back in */
    setTimeout(()=>b.classList.remove("fade-switch"),100);
  },150);
}

function applyTvGuide1990Capsules(){
  document.querySelectorAll(".chan-col .chan-name").forEach((box,i)=>{
    if(box.querySelector(".channel-number")) return;
    const cap=document.createElement("span");
    cap.className="channel-number";
    cap.textContent=String(i+1);
    box.innerHTML="";
    box.appendChild(cap);
  });
}

document.addEventListener("DOMContentLoaded",()=>{
  const t=localStorage.getItem("theme")||"dark";
  setTheme(t);
  if(t==="tvguide1990") requestAnimationFrame(applyTvGuide1990Capsules);
});

function updateClock() {
    const now = new Date();
    const el = document.getElementById('clock');
    if (el) {
        el.textContent = now.toLocaleString([], {
            weekday:'short', month:'short', day:'numeric',
            hour:'2-digit', minute:'2-digit', second:'2-digit'
        });
    }
}

</script>

<script>
document.addEventListener("DOMContentLoaded",()=>{
  if(document.body.classList.contains("tvguide1990")){
    document.querySelectorAll(".chan-col").forEach((col,idx)=>{
      const nameBox=col.querySelector(".chan-name");
      if(!nameBox||col.classList.contains("tvguide1990-applied"))return;

      // Create or replace channel number capsule
      const chanNum=idx+1; // sequential numbering
      const capsule=document.createElement("div");
      capsule.className="channel-number";
      capsule.textContent=chanNum;

      // Clean out nameBox contents (remove logos/text)
      nameBox.innerHTML="";
      nameBox.appendChild(capsule);
      col.classList.add("tvguide1990-applied");
    });
  }
});
</script>

<!-- Android / Fire / Google TV detection -->
<script>
// Simplify menu for Android/Fire/Google TV browsers
(function(){
  const ua = navigator.userAgent || "";
  const isTV = /AFT|Silk|Android\sTV|GoogleTV|MiBOX|BRAVIA|Shield|TCL|Hisense|Puffin|TV\sBro/i.test(ua);
  if (!isTV) return;

  console.log("RetroIPTVGuide: Simplifying menu for TV mode");

  // Hide "User Admin" and "Settings"
  document.getElementById("userAdminMenu")?.remove();
  document.getElementById("settingsMenu")?.remove();
  document.getElementById("manageUsersMenu")?.remove();

  if (homeLink) homeLink.remove();

  // Insert simplified Themes dropdown
  const linksContainer = document.querySelector(".header .links");
  if (linksContainer){
    const themesMenu = document.createElement("div");
    themesMenu.className = "dropdown";
    themesMenu.innerHTML = `
      <button class="dropbtn">THEMES â–¾</button>
      <div class="dropdown-content">
        <a href="#" onclick="setTheme('light');return false;">Light</a>
        <a href="#" onclick="setTheme('dark');return false;">Dark</a>
        <a href="#" onclick="setTheme('retro-aol');return false;">AOL / CompuServe</a>
        <a href="#" onclick="setTheme('retro-magazine');return false;">TV Guide Magazine</a>
        <a href="#" onclick="setTheme('directv');return false;">DirecTV</a>
        <a href="#" onclick="setTheme('comcast');return false;">Comcast</a>
      </div>`;
    // Place Themes before Logout link
    const logoutLink = document.querySelector('.header .links a[href*="logout"]');
    linksContainer.insertBefore(themesMenu, logoutLink);
  }
})();
</script>


</body>
</html>
