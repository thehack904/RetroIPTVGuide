<!doctype html>
<html>
<head>
    <title>Live TV Guide</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
    <style>
        /* Page-specific dynamic styles that need template variables */
        .time-cell { flex:0 0 {{ 30*SCALE }}px; width:{{ 30*SCALE }}px; }
        .grid-content { width: {{ total_width }}px; }
        .now-line { left: {{ now_offset }}px; }
    </style>
</head>
<body>
<div class="header">
    <div class="links">
        <span style="margin-right:20px; font-weight:bold;">Active Tuner: {{ current_tuner }}</span>
        <a href="{{ url_for('guide') }}">HOME</a>

        {% if current_user is defined and current_user.username == 'admin' %}
        <!-- âœ… Added next to USER ADMIN -->
		<a href="{{ url_for('manage_users') }}" id="manageUsersMenu">MANAGE USERS</a>
        {% endif %}

        <div class="dropdown" id="settingsMenu">
            <button class="dropbtn">SETTINGS â–¾</button>
            <div class="dropdown-content">
                {% if current_user is defined and current_user.username == 'admin' %}
                <a href="{{ url_for('change_tuner') }}">Change Tuner</a>
                <a href="{{ url_for('view_logs') }}">Logs</a>
                <li><a href="{{ url_for('about') }}">About</a></li>
                {% endif %}
                <a href="{{ url_for('change_password') }}">Change Password</a>
				<li class="submenu">
				  <a href="#">Themes</a>
				  <ul class="submenu-content">
				    <li><a href="#" onclick="setTheme('light'); return false;">Light</a></li>
				    <li><a href="#" onclick="setTheme('dark'); return false;">Dark</a></li>
					<li><a href="#" onclick="setTheme('retro-aol'); return false;">AOL / CompuServe</a></li>
					<li><a href="#" onclick="setTheme('retro-magazine'); return false;">TV Guide Magazine</a></li>
					<li><a href="#" onclick="setTheme('directv'); return false;">DirecTV</a></li>
					<li><a href="#" onclick="setTheme('comcast'); return false;">Comcast</a></li>
				  </ul>
				</li>
            </div>
        </div>

        <a href="{{ url_for('logout') }}">LOGOUT</a>
    </div>

    <div id="clock" class="clock">--:-- --</div>
</div>


<!-- Player row: summary left, video right -->
<div class="player">
    <div class="summary" id="summary">
        <h3>Program Info</h3>
        <p>Click a channel on the left to start playback.</p>
    </div>
    <!-- <video id="video" controls></video> -->
	<video id="video" controls playsinline preload="metadata" tabindex="0"></video>
</div>

<!-- Guide grid -->
<div class="guide-outer">
    <div class="guide-row">
        <div class="chan-col"><div class="chan-header"></div></div>
        <div class="grid-col">
            <div class="time-header-wrap">
                <div class="grid-content">
                    <div class="time-header">
                        {% for t in hours_header %}
                            <div class="time-cell" data-utc="{{ t.isoformat() }}">{{ t.isoformat() }}</div>
                        {% endfor %}
                    </div>
                    <div class="now-line" id="nowLine"></div>
                </div>
            </div>
        </div>
    </div>

    {% for ch in channels %}
    <div class="guide-row" data-cid="{{ ch.tvg_id }}">
        <div class="chan-col">
            <div class="chan-name"
                 data-url="{{ ch.url }}"
                 data-cid="{{ ch.tvg_id }}"
                 data-name="{{ ch.name|e }}">
                {% if ch.logo %}<img src="{{ ch.logo }}" alt="">{% endif %}
                <span>{{ ch.name }}</span>
            </div>
        </div>
        <div class="grid-col">
            <div class="grid-content">
			{% set cid = ch.tvg_id %}
			{% set channel_epg = epg[cid] if cid in epg else [] %}
			{% if channel_epg|length == 0 %}
				<div class="program no-guide"
					style="left:0px; width:{{ 60 * SCALE }}px;">
					No Guide Data Available
				</div>
			{% else %}
				{% for prog in channel_epg %}
					{% if prog.title == 'No Guide Data Available' %}
						<div class="program no-guide"
							style="left:0px; width:{{ 60 * SCALE }}px;">
							{{ prog.title }}
						</div>
					{% elif prog.start and prog.stop %}
						{% set left = ((prog.start - grid_start).total_seconds()/60) * SCALE %}
						{% set calc_width = (prog.stop - prog.start).total_seconds()/60 * SCALE %}
						{% set width = 24 if calc_width < 24 else calc_width %}
						<div class="program {% if prog.start <= now <= prog.stop %}now{% endif %}"
							style="left:{{ left }}px; width:{{ width }}px;"
							data-start="{{ prog.start.isoformat() }}"
							data-stop="{{ prog.stop.isoformat() }}"
							data-title="{{ prog.title }}"
							data-desc="{{ prog.desc }}">
							{{ prog.title }}
						</div>
					{% endif %}
				{% endfor %}
			{% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script src="{{ url_for('static', filename='hls.js') }}"></script>
<script>
let hlsInstance = null;
let currentChannelId = null;

function playChannel(url, cid, name) {
    const video = document.getElementById('video');
    currentChannelId = cid;
    updateSummary(cid, name);

    // ðŸ”¥ Log playback to backend
    fetch("/play_channel", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "channel_name=" + encodeURIComponent(name)
    });

    if (hlsInstance) { hlsInstance.destroy(); hlsInstance = null; }
    if (Hls.isSupported()) {
        hlsInstance = new Hls();
        hlsInstance.loadSource(url);
        hlsInstance.attachMedia(video);
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
    } else {
        video.src = url;
        video.play().catch(()=>{});
    }
}

function updateSummary(cid, fallbackName) {
    const summary = document.getElementById('summary');
    const now = new Date();
    const row = document.querySelector(`.guide-row[data-cid="${cid}"]`);
    if (!row) return;

    let currentProg = null;
    row.querySelectorAll('.program').forEach(prog => {
        const start = new Date(prog.dataset.start);
        const stop = new Date(prog.dataset.stop);
        if (start <= now && stop >= now) currentProg = prog;
    });

    if (currentProg) {
        const title = currentProg.dataset.title || fallbackName;
        const desc = currentProg.dataset.desc || '';
        const start = new Date(currentProg.dataset.start);
        const stop = new Date(currentProg.dataset.stop);
        summary.innerHTML = `<h3>${title}</h3>
                             <p>${desc}</p>
                             <p>${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${stop.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</p>`;
    } else {
        summary.innerHTML = `<h3>${fallbackName}</h3><p>No Program Info</p>`;
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem("theme") || "dark";
    document.body.classList.add(savedTheme);

    document.querySelectorAll('.chan-name').forEach(el => {
        el.addEventListener('click', () => {
            playChannel(el.dataset.url, el.dataset.cid, el.dataset.name);
        });
    });

    document.querySelectorAll('.time-cell').forEach(cell => {
        const utc = new Date(cell.dataset.utc);
        cell.textContent = utc.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    });

    document.querySelectorAll('.program').forEach(prog => {
        const start = new Date(prog.dataset.start);
        const stop = new Date(prog.dataset.stop);
        prog.title = `${prog.dataset.title}\n${start.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} - ${stop.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`;
    });

    updateClock();
    setInterval(updateClock, 1000);
    updateNowLine();
    setInterval(updateNowLine, 60000);
});

function setTheme(theme) {
    const body = document.body;
    // Remove all possible theme classes
    body.classList.remove("light", "dark", "retro-tvguide", "retro-aol", "retro-webtv", "retro-tvguide2000", "retro-magazine", "directv", "comcast");
    // Add the new one
    body.classList.add(theme);
    // Save it for next load
    localStorage.setItem("theme", theme);
}

// On load, apply saved theme or default
document.addEventListener("DOMContentLoaded", () => {
    const savedTheme = localStorage.getItem("theme") || "dark";
    setTheme(savedTheme);
});

function updateClock() {
    const now = new Date();
    const el = document.getElementById('clock');
    if (el) {
        el.textContent = now.toLocaleString([], {
            weekday:'short', month:'short', day:'numeric',
            hour:'2-digit', minute:'2-digit', second:'2-digit'
        });
    }
}

function updateNowLine() {
    const gridStart = new Date("{{ grid_start.isoformat() }}");
    const scale = {{ SCALE }};
    const now = new Date();
    const minutesFromStart = (now - gridStart) / 60000;
    const nl = document.getElementById('nowLine');
    if (nl) nl.style.left = (minutesFromStart * scale) + "px";
}


</script>

<!-- Android / Fire / Google TV detection -->
<script>
// Simplify menu for Android/Fire/Google TV browsers
(function(){
  const ua = navigator.userAgent || "";
  const isTV = /AFT|Silk|Android\sTV|GoogleTV|MiBOX|BRAVIA|Shield|TCL|Hisense|Puffin|TV\sBro/i.test(ua);
  if (!isTV) return;

  console.log("RetroIPTVGuide: Simplifying menu for TV mode");

  // Hide "User Admin" and "Settings"
  document.getElementById("userAdminMenu")?.remove();
  document.getElementById("settingsMenu")?.remove();
  document.getElementById("manageUsersMenu")?.remove();

  // Remove the HOME link
  const homeLink = document.querySelector('.header .links a[href*="guide"]');
  if (homeLink) homeLink.remove();

  // Insert simplified Themes dropdown
  const linksContainer = document.querySelector(".header .links");
  if (linksContainer){
    const themesMenu = document.createElement("div");
    themesMenu.className = "dropdown";
    themesMenu.innerHTML = `
      <button class="dropbtn">THEMES â–¾</button>
      <div class="dropdown-content">
        <a href="#" onclick="setTheme('light');return false;">Light</a>
        <a href="#" onclick="setTheme('dark');return false;">Dark</a>
        <a href="#" onclick="setTheme('retro-aol');return false;">AOL / CompuServe</a>
        <a href="#" onclick="setTheme('retro-magazine');return false;">TV Guide Magazine</a>
        <a href="#" onclick="setTheme('directv');return false;">DirecTV</a>
        <a href="#" onclick="setTheme('comcast');return false;">Comcast</a>
      </div>`;
    // Place Themes before Logout link
    const logoutLink = document.querySelector('.header .links a[href*="logout"]');
    linksContainer.insertBefore(themesMenu, logoutLink);
  }
})();
</script>


</body>
</html>
